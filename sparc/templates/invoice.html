{% extends "index.html" %}

{% block content %}

{% load static %}
{% load humanize %}

<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Invoice {{ invoice.invoice_no }} - Inner Sparc Realty</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <script>
    tailwind.config = {
      theme: {
        extend: {
          colors: {
            primary: '#1d4ed8',
            accent: '#0e7490',
            dark: '#1e293b'
          }
        }
      }
    }
  </script>
  <style>
    @media print {
      .no-print {
        display: none !important;
      }
      
      /* Hide all navigation elements */
      #mobile-toggle,
      .mobile-menu-btn,
      #sidebar,
      .sidebar,
      nav,
      .navbar,
      header nav,
      .navigation,
      .menu-toggle,
      .hamburger {
        display: none !important;
      }
      
      /* Hide mobile menu icons and buttons */
      #menu-icon,
      #close-icon,
      .fa-bars,
      .fa-times,
      svg[stroke="currentColor"] {
        display: none !important;
      }
      
      /* Ensure proper layout without sidebar */
      .max-w-\[calc\(100\%-1rem\)\] {
        max-width: 100% !important;
        margin-left: 0 !important;
        margin-right: 0 !important;
      }
      
      body {
        -webkit-print-color-adjust: exact;
        print-color-adjust: exact;
        margin: 0 !important;
        padding: 0 !important;
      }
      
      .page-break {
        page-break-after: always;
      }
      
      /* Ensure blue header is visible */
      .bg-blue-600 {
        background-color: #2563eb !important;
        color: white !important;
        -webkit-print-color-adjust: exact !important;
        print-color-adjust: exact !important;
      }
    }
    .btn-sig {
      background-color: #e0e7ff;
      color: #3730a3;
      padding: 4px 8px;
      border-radius: 4px;
      font-size: 10px;
      font-weight: 600;
      transition: background-color 0.2s;
    }
    .btn-sig:hover {
      background-color: #c7d2fe;
    }
    .btn-sig-clear {
      background-color: #fee2e2;
      color: #991b1b;
      padding: 4px 8px;
      border-radius: 4px;
      font-size: 10px;
      font-weight: 600;
      transition: background-color 0.2s;
    }
    .btn-sig-clear:hover {
      background-color: #fecaca;
    }
  </style>
</head>
<body class="bg-gray-100 font-sans">
  <div class="max-w-4xl mx-auto my-10 p-8 bg-white rounded-lg shadow-2xl">
    <!-- Header -->
    <header class="flex justify-between items-start pb-6 border-b-2 border-gray-200">
      <div class="flex items-center">
        {% if is_pdf_generation and logo_path %}
        <img src="{{ logo_path }}" alt="Inner Sparc Realty Logo" class="h-16 mr-4">
        {% else %}
        <img src="{% static 'media/LOGO.png' %}" alt="Inner Sparc Realty Logo" class="h-16 mr-4">
        {% endif %}
        <div>
          <h1 class="text-2xl font-bold text-gray-800">INNER SPARC REALTY CORPORATION</h1>
          <p class="text-sm text-blue-600 font-semibold">Professional Real Estate Services</p>
          <div class="mt-4 text-xs text-gray-500">
            <p class="flex items-center"><i class="fas fa-map-marker-alt w-4 mr-1"></i> BLK 26 LOT 4 PH 3 AVIDA RESIDENCES STA CATALINA SALAWAG, <br> DASMARIÑAS CITY, CAVITE 4114</p> <br>
            <p class="flex items-center"><i class="fas fa-id-card w-4 mr-1"></i> TIN 625-453-930-00000</p>
          </div>
        </div>
      </div>
      <div class="text-right">
        <div class="px-6 py-2 bg-blue-600 text-white font-bold text-lg rounded-md shadow-md">
          BILLING STATEMENT
        </div>
        <div class="mt-4 p-3 bg-gray-50 border border-gray-300 rounded-md">
          <p class="text-xs font-semibold text-gray-500">BILLING #</p>
          <p class="text-xl font-bold text-gray-800">{{ invoice.invoice_no }}</p>
        </div>
      </div>
    </header>

    <!-- Bill To & Details -->
    <section class="grid grid-cols-2 gap-8 mt-6 pb-6">
      <div class="border-l-4 border-blue-600 pl-4">
        <h2 class="text-sm font-bold text-gray-500 mb-2">BILL TO</h2>
        <!-- View Mode -->
        <div id="bill-to-view" class="edit-section">
          <p class="font-bold text-gray-800">{{ invoice.client_name }}</p>
          <p class="text-xs text-gray-600 whitespace-pre-line">{{ invoice.client_address }}</p>
          <p class="mt-2 text-xs text-gray-600"><span class="font-semibold">VAT-REG TIN:</span> {{ invoice.client_tin }}</p>
          <p class="text-xs text-gray-600"><span class="font-semibold">Business Style:</span> {{ invoice.client_name }}</p>
        </div>
        <!-- Edit Mode -->
        <div id="bill-to-edit" class="edit-section hidden">
          <div class="space-y-2">
            <input type="text" id="edit-client-name" value="{{ invoice.client_name }}" class="w-full px-2 py-1 text-sm border border-gray-300 rounded font-bold text-gray-800">
            <textarea id="edit-client-address" rows="3" class="w-full px-2 py-1 text-xs border border-gray-300 rounded text-gray-600">{{ invoice.client_address }}</textarea>
            <input type="text" id="edit-client-tin" value="{{ invoice.client_tin }}" class="w-full px-2 py-1 text-xs border border-gray-300 rounded text-gray-600" placeholder="VAT-REG TIN">
          </div>
        </div>
      </div>
      <div class="grid grid-cols-2 gap-4 text-sm">
        <div>
          <h3 class="font-bold text-gray-500 mb-2">BILLING DETAILS</h3>
          <!-- View Mode -->
          <div id="billing-details-view" class="edit-section">
            <p><span class="font-semibold">Reservation Date:</span> {{ invoice.issue_date|date:'M d, Y' }}</p>
            <p><span class="font-semibold">Due Date:</span> {{ invoice.due_date|date:'M d, Y' }}</p>
            <p><span class="font-semibold">Terms:</span> {{ payment_terms }}</p>
          </div>
          <!-- Edit Mode -->
          <div id="billing-details-edit" class="edit-section hidden">
            <div class="space-y-2">
              <div>
                <label class="block text-xs font-semibold text-gray-500">Date Started:</label>
                <input type="date" id="edit-issue-date" value="{{ invoice.issue_date|date:'Y-m-d' }}" class="w-full px-2 py-1 text-xs border border-gray-300 rounded">
              </div>
              <div>
                <label class="block text-xs font-semibold text-gray-500">Due Date:</label>
                <input type="date" id="edit-due-date" value="{{ invoice.due_date|date:'Y-m-d' }}" class="w-full px-2 py-1 text-xs border border-gray-300 rounded">
              </div>
              <div>
                <label class="block text-xs font-semibold text-gray-500">Terms:</label>
                <input type="text" id="edit-payment-terms" value="{{ payment_terms }}" class="w-full px-2 py-1 text-xs border border-gray-300 rounded">
              </div>
            </div>
          </div>
        </div>
        <div>
          <h3 class="font-bold text-gray-500 mb-2">REFERENCE</h3>
          <!-- View Mode -->
          <div id="reference-view" class="edit-section">
            <p>{{ invoice.reference_no }}</p>
          </div>
          <!-- Edit Mode -->
          <div id="reference-edit" class="edit-section hidden">
            <input type="text" id="edit-reference-no" value="{{ invoice.reference_no }}" class="w-full px-2 py-1 text-sm border border-gray-300 rounded">
          </div>
        </div>
      </div>
    </section>


    

    <!-- Items Table -->
    <section class="mb-8">
      <table class="w-full text-sm">
        <thead class="bg-gray-50">
          <tr>
            <th class="p-3 text-left font-semibold text-gray-600 border-b-2 border-gray-200">Item Code</th>
            <th class="p-3 text-left font-semibold text-gray-600 border-b-2 border-gray-200">Description</th>
            <th class="p-3 text-center font-semibold text-gray-600 border-b-2 border-gray-200">Quantity</th>
            <th class="p-3 text-right font-semibold text-gray-600 border-b-2 border-gray-200">Amount</th>
            <th class="p-3 text-center font-semibold text-gray-600 border-b-2 border-gray-200">Due Date</th>
            <th class="p-3 text-center font-semibold text-gray-600 border-b-2 border-gray-200">Status</th>
            <th class="p-3 text-center font-semibold text-gray-600 border-b-2 border-gray-200">Percentage</th>
          </tr>
        </thead>
        <tbody id="items-table-body">
          {% for item in stored_items %}
            <tr class="bg-white item-row" data-item-id="{{ forloop.counter }}">
              <!-- View Mode -->
              <td class="p-3 border-b border-gray-200 item-view">
                <span class="item-code-display">{{ item.item_code }}</span>
                <input type="text" class="item-code-edit hidden w-full px-1 py-0.5 text-xs border border-gray-300 rounded" value="{{ item.item_code }}">
              </td>
              <td class="p-3 border-b border-gray-200 item-view">
                <span class="item-description-display">Commission Claim for Unit ({{ item.unit_id }}) sold to ({{ item.buyer_name }})
                  {% if is_combined_invoice %}
                    <div class="text-xs text-gray-500 mt-1">
                      Commission: 
                      {% for tranche in combined_tranches %}
                        #{{ tranche.tranche_number }}{% if not forloop.last %}, {% endif %}
                      {% endfor %}
                    </div>
                  {% endif %}
                </span>
                <textarea class="item-description-edit hidden w-full px-1 py-0.5 text-xs border border-gray-300 rounded" rows="3">{{ item.description }}</textarea>
              </td>
              <td class="p-3 text-center border-b border-gray-200 item-view">
                <span class="item-quantity-display">{{ item.quantity }}</span>
                <input type="number" class="item-quantity-edit hidden w-full px-1 py-0.5 text-xs border border-gray-300 rounded text-center" value="{{ item.quantity }}">
              </td>
              <td class="p-3 text-right font-semibold text-gray-800 border-b border-gray-200 item-view">
                <span class="item-amount-display">₱{{ item.amount|floatformat:2|intcomma }}</span>
                <input type="number" step="0.01" class="item-amount-edit hidden w-full px-1 py-0.5 text-xs border border-gray-300 rounded text-right" value="{{ item.amount }}">
              </td>
              <td class="p-3 text-center border-b border-gray-200 item-view">
                <span class="item-due-date-display">{{ invoice.due_date|date:'M d, Y' }}</span>
                <input type="date" class="item-due-date-edit hidden w-full px-1 py-0.5 text-xs border border-gray-300 rounded" value="{{ item.due_date }}">
              </td>
              <td class="p-3 text-center border-b border-gray-200 item-view">
                <span class="item-status-display">
                  {% if item.status %}
                  <span class="inline-block px-2 py-0.5 text-xs font-semibold rounded-full 
                    {% if item.status == 'Received' %}bg-green-100 text-green-800{% elif item.status == 'Overdue' %}bg-red-100 text-red-800{% else %}bg-yellow-100 text-yellow-800{% endif %}">
                    {{ item.status }}
                  </span>
                  {% else %}-{% endif %}
                </span>
                <select class="item-status-edit hidden w-full px-1 py-0.5 text-xs border border-gray-300 rounded">
                  <option value="Pending" {% if item.status == 'Pending' %}selected{% endif %}>Pending</option>
                  <option value="Received" {% if item.status == 'Received' %}selected{% endif %}>Received</option>
                  <option value="Overdue" {% if item.status == 'Overdue' %}selected{% endif %}>Overdue</option>
                </select>
              </td>
              <td class="p-3 text-center font-medium border-b border-gray-200 item-view">
                <span class="item-percentage-display">{% if item.percentage %}{{ item.percentage|floatformat:2 }}%{% else %}-{% endif %}</span>
                <input type="number" step="0.01" min="0" max="100" class="item-percentage-edit hidden w-full px-1 py-0.5 text-xs border border-gray-300 rounded text-center" value="{{ item.percentage|default:0 }}">
              </td>
            </tr>
          {% endfor %}
          <!-- Add Item Button Row (hidden by default, shown in edit mode) -->
          <tr id="add-item-row" class="bg-gray-50 hidden">
            <td colspan="7" class="p-3 text-center border-b border-gray-200">
              <button type="button" id="add-item-btn" class="px-4 py-2 bg-green-500 hover:bg-green-600 text-white text-xs font-semibold rounded transition">
                <i class="fas fa-plus mr-1"></i> Add Item
              </button>
            </td>
          </tr>
        </tbody>
      </table>
    </section>


    <!-- Summary & Billing History (Right Side) -->
    <section class="grid grid-cols-2 gap-8 mb-8">
      <!-- Empty Left Column -->
      <div></div>

      <!-- Right Column -->
      <div class="space-y-8">
        <!-- Summary -->
        <div>
          <div class="border border-gray-200 rounded-lg overflow-hidden h-full">
            <div class="bg-gray-50 p-3 border-b border-gray-200">
              <h3 class="font-bold text-sm text-gray-600">SUMMARY</h3>
            </div>
            <div class="p-4 space-y-2 text-sm">
              {% if is_combined_invoice %}
                <!-- Combined Invoice Summary - Simplified to match Down Payment Schedule -->
                <div class="flex justify-between">
                  <span class="text-gray-600">Net Commission:</span>
                  <span class="font-medium text-gray-800">₱ {{ net_price|floatformat:2|intcomma }}</span>
                </div>
                <div class="flex justify-between">
                  <span class="text-gray-600">Less Tax:</span>
                  <span class="font-medium text-gray-800">₱ {{ vat_amount|floatformat:2|intcomma }}</span>
                </div>
                <div class="flex justify-between pt-3 mt-3 border-t-2 border-gray-200">
                  <span class="font-bold text-gray-800">NET COMMISSION PAYABLE:</span>
                  <span class="font-bold text-blue-600">₱ {{ total_due|floatformat:2|intcomma }}</span>
                </div>
              {% else %}
                <!-- Single Invoice Summary -->
                {% if is_lto_invoice %}
                  <!-- LTO Invoice Summary -->
                  <div class="flex justify-between">
                    <span class="text-gray-600">LTO Commission:</span>
                    <span class="font-medium text-gray-800">₱ {{ lto_deduction_value|floatformat:2|intcomma }}</span>
                  </div>
                  <div class="flex justify-between">
                    <span class="text-gray-600">Less: Withholding Tax ({{ invoice.option2_tax_rate|floatformat:0 }}%):</span>
                    <span class="font-medium text-gray-800">₱ {{ lto_deduction_tax|floatformat:2|intcomma }}</span>
                  </div>
                  <div class="flex justify-between pt-3 mt-3 border-t-2 border-gray-200">
                    <span class="font-bold text-gray-800">NET COMMISSION PAYABLE:</span>
                    <span class="font-bold text-blue-600">₱ {{ lto_deduction_net|floatformat:2|intcomma }}</span>
                  </div>
                {% else %}
                  <!-- DP Invoice Summary - Simplified to match Down Payment Schedule -->
                  <div class="flex justify-between">
                    <span class="text-gray-600">Net Commission:</span>
                    <span class="font-medium text-gray-800">₱ {{ net_price|floatformat:2|intcomma }}</span>
                  </div>
                  <div class="flex justify-between">
                    <span class="text-gray-600">Less Tax:</span>
                    <span class="font-medium text-gray-800">₱ {{ vat_amount|floatformat:2|intcomma }}</span>
                  </div>
                  <div class="flex justify-between pt-3 mt-3 border-t-2 border-gray-200">
                    <span class="font-bold text-gray-800">NET COMMISSION PAYABLE:</span>
                    <span class="font-bold text-blue-600">₱ {{ total_due|floatformat:2|intcomma }}</span>
                  </div>
                {% endif %}
              {% endif %}
            </div>
          </div>
        </div>

       
    </section>

     <!-- Billing History -->
     <div>
      <div class="border border-gray-200 rounded-lg overflow-hidden">
        <div class="bg-gray-50 p-3 border-b border-gray-200">
          <h3 class="font-bold text-sm text-gray-600">BILLING HISTORY</h3>
        </div>
        <table class="w-full text-xs">
          <thead>
            <tr class="text-left">
              <th class="p-2 font-semibold text-gray-500 border-b">Date Received</th>
              <th class="p-2 font-semibold text-gray-500 border-b text-right">Amount</th>
              <th class="p-2 font-semibold text-gray-500 border-b text-center">Status</th>
              <th class="p-2 font-semibold text-gray-500 border-b text-center">Percentage</th>
            </tr>
          </thead>
          <tbody>
            {% for item in billing_statement_items %}
            <tr>
              <td class="p-2 border-b border-gray-100">{{ item.date_received|date:"M d, Y" }}</td>
              <td class="p-2 text-right border-b border-gray-100">₱ {{ item.amount|floatformat:2|intcomma }}</td>
              <td class="p-2 text-center border-b border-gray-100">
                <span class="inline-block px-2 py-0.5 text-xs font-semibold rounded-full bg-green-100 text-green-800">{{ item.status }}</span>
              </td>
              <td class="p-2 text-center font-medium border-b border-gray-100">{{ item.percentage|floatformat:2 }}%</td>
            </tr>
            {% empty %}
            <tr>
              <td colspan="4" class="p-4 text-center text-gray-400">No history available.</td>
            </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
    </div>

    <br>

    <div>
      <div class="p-4 bg-blue-50 border-l-4 border-blue-500 rounded-r-md text-xs text-gray-700 h-full">
        <h4 class="font-bold text-sm text-gray-800 mb-2 flex items-center">
          <i class="fas fa-info-circle mr-2 text-blue-600"></i> Notes & Payment Information
        </h4>
        <ul class="list-disc list-inside space-y-1">
          <li>If you have any questions concerning this invoice, please contact our billing department at <a href="mailto:innersparcrealtyservices@gmail.com" class="text-blue-600 hover:underline">innersparcrealtyservices@gmail.com</a>.</li>
        </ul>
        <p class="mt-3 italic text-gray-500">Thank you for your prompt payment.</p>
      </div>
    </div>
    <br>

    <!-- Signatures -->
    <section class="grid grid-cols-3 gap-6 text-center text-xs pt-6 border-t-2 border-gray-200">
      <div class="signature-container" data-role="prepared_by">
        <img id="signature-prepared_by" src="{% if invoice.prepared_by_signature %}{{ invoice.prepared_by_signature.url }}{% else %}{% static 'media/placeholder.png' %}{% endif %}" alt="Signature" class="h-16 w-auto mx-auto mb-2 border-b pb-2">
        <p class="font-bold">Prepared By</p>
        <p class="text-gray-600">{{ invoice.prepared_by.get_full_name }}</p>
        <p class="text-gray-500">{{ invoice.created_at|date:"m/d/Y" }}</p>
        {% if can_prepare %}
        <div class="mt-2 space-x-1 no-print">
          <button onclick="document.getElementById('signature-upload-prepared_by').click()" class="btn-sig">Attach Signature</button>
          <button class="btn-sig-clear clear-signature-btn">Clear</button>
          <input type="file" id="signature-upload-prepared_by" class="hidden" accept="image/*">
        </div>
        {% endif %}
      </div>
      <div class="signature-container" data-role="checked_by">
        <img id="signature-checked_by" src="{% if invoice.checked_by_signature %}{{ invoice.checked_by_signature.url }}{% else %}{% static 'media/placeholder.png' %}{% endif %}" alt="Signature" class="h-16 w-auto mx-auto mb-2 border-b pb-2">
        <p class="font-bold">Checked By</p>
        {% if invoice.checked_by_signature %}
        <p class="text-gray-600">Inner SPARC Realty Corporation</p>
        <p class="text-gray-500">{{ invoice.checked_by_date|date:"m/d/Y" }}</p>
        {% else %}
        <p class="text-gray-400 italic">(Not yet checked)</p>
        {% endif %}
        {% if can_check %}
        <div class="mt-2 space-x-1 no-print">
          <button onclick="document.getElementById('signature-upload-checked_by').click()" class="btn-sig">Attach Signature</button>
          <button class="btn-sig-clear clear-signature-btn">Clear</button>
          <input type="file" id="signature-upload-checked_by" class="hidden" accept="image/*">
        </div>
        {% endif %}
      </div>
      <div class="signature-container" data-role="approved_by">
        <img id="signature-approved_by" src="{% if invoice.approved_by_signature %}{{ invoice.approved_by_signature.url }}{% else %}{% static 'media/placeholder.png' %}{% endif %}" alt="Signature" class="h-16 w-auto mx-auto mb-2 border-b pb-2">
        <p class="font-bold">Approved By</p>
        {% if invoice.approved_by_signature %}
        <p class="text-gray-600">Inner SPARC Realty Corporation</p>
        <p class="text-gray-500">{{ invoice.approved_by_date|date:"m/d/Y" }}</p>
        {% else %}
        <p class="text-gray-400 italic">(Not yet approved)</p>
        {% endif %}
        {% if can_approve %}
        <div class="mt-2 space-x-1 no-print">
          <button onclick="document.getElementById('signature-upload-approved_by').click()" class="btn-sig">Attach Signature</button>
          <button class="btn-sig-clear clear-signature-btn">Clear</button>
          <input type="file" id="signature-upload-approved_by" class="hidden" accept="image/*">
        </div>
        {% endif %}
      </div>
    </section>

    <!-- Footer -->
    <footer class="text-center text-xs text-gray-500 mt-8 pt-6 border-t-2 border-gray-200">
      <p>Thank you for your business! • Payment due by {{ invoice.due_date|date:'M d, Y' }}</p>
      <div class="flex justify-center items-center space-x-4 mt-2">
        <p><i class="fas fa-phone-alt mr-1"></i>(046) 458-0706</p>
        <p><i class="fas fa-envelope mr-1"></i>innersparcrealtyservices@gmail.com</p>
        <p><i class="fas fa-globe mr-1"></i>https://www.innersparcrealty.com/</p>
      </div>
    </footer>
  </div>

  <!-- Save/Cancel Buttons for Inline Editing -->
  <div id="edit-controls" class="max-w-5xl mx-auto mt-4 flex justify-center space-x-4 no-print hidden">
    <button id="save-all-btn" class="px-6 py-3 bg-green-600 hover:bg-green-700 text-white font-semibold rounded-lg shadow-md transition flex items-center">
      <i class="fas fa-save mr-2"></i> Save Changes
    </button>
    <button id="cancel-all-btn" class="px-6 py-3 bg-gray-500 hover:bg-gray-600 text-white font-semibold rounded-lg shadow-md transition flex items-center">
      <i class="fas fa-times mr-2"></i> Cancel
    </button>
  </div>

  <!-- Action Buttons -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
  
  <div id="alert-container" class="max-w-5xl mx-auto mt-4"></div>
  <div class="max-w-5xl mx-auto mt-6 flex justify-center space-x-4 no-print">
   
    <button id="downloadPdf" onclick="printInvoice()" class="px-6 py-3 bg-green-600 hover:bg-green-700 text-white font-semibold rounded-lg shadow-md transition flex items-center no-print">
      <i class="fas fa-download mr-2"></i> Download PDF
    </button>
    <button id="toggle-edit-btn" class="px-6 py-3 bg-yellow-500 hover:bg-yellow-600 text-white font-semibold rounded-lg shadow-md transition flex items-center">
      <i class="fas fa-edit mr-2"></i> <span id="edit-btn-text">Edit Invoice</span>
    </button>
  </div>

  <!-- CSRF Token for AJAX requests -->
  {% csrf_token %}

<script>
document.addEventListener('DOMContentLoaded', function() {
    const csrftoken = document.querySelector('[name=csrfmiddlewaretoken]')?.value || '{{ csrf_token }}';
    let isEditMode = false;
    let originalData = {};

    function showAlert(message, type = 'success') {
        const alertContainer = document.getElementById('alert-container');
        const alert = document.createElement('div');
        alert.className = `p-4 mb-4 text-sm rounded-lg ${type === 'success' ? 'bg-green-100 text-green-700' : 'bg-red-100 text-red-700'}`;
        alert.textContent = message;
        alertContainer.innerHTML = '';
        alertContainer.appendChild(alert);
        setTimeout(() => alert.remove(), 5000);
    }

    // Store original data for cancellation
    function storeOriginalData() {
        originalData = {
            clientName: document.getElementById('edit-client-name')?.value || '',
            clientAddress: document.getElementById('edit-client-address')?.value || '',
            clientTin: document.getElementById('edit-client-tin')?.value || '',
            issueDate: document.getElementById('edit-issue-date')?.value || '',
            dueDate: document.getElementById('edit-due-date')?.value || '',
            paymentTerms: document.getElementById('edit-payment-terms')?.value || '',
            referenceNo: document.getElementById('edit-reference-no')?.value || '',
            items: [],
            originalAmounts: []  // Track original amounts to detect financial changes
        };
        
        // Store item data
        document.querySelectorAll('.item-row').forEach((row, index) => {
            const amount = row.querySelector('.item-amount-edit')?.value || '';
            originalData.items.push({
                code: row.querySelector('.item-code-edit')?.value || '',
                description: row.querySelector('.item-description-edit')?.value || '',
                quantity: row.querySelector('.item-quantity-edit')?.value || '',
                amount: amount,
                dueDate: row.querySelector('.item-due-date-edit')?.value || '',
                status: row.querySelector('.item-status-edit')?.value || '',
                percentage: row.querySelector('.item-percentage-edit')?.value || ''
            });
            originalData.originalAmounts.push(parseFloat(amount) || 0);
        });
    }

    // Toggle between view and edit modes
    function toggleEditMode() {
        isEditMode = !isEditMode;
        const editSections = document.querySelectorAll('.edit-section');
        const editControls = document.getElementById('edit-controls');
        const editBtnText = document.getElementById('edit-btn-text');
        const addItemRow = document.getElementById('add-item-row');
        
        if (isEditMode) {
            storeOriginalData();
            editSections.forEach(section => {
                if (section.id.includes('-view')) {
                    section.classList.add('hidden');
                } else if (section.id.includes('-edit')) {
                    section.classList.remove('hidden');
                }
            });
            
            // Show edit inputs in table
            document.querySelectorAll('.item-view .item-code-display, .item-view .item-description-display, .item-view .item-quantity-display, .item-view .item-amount-display, .item-view .item-due-date-display, .item-view .item-status-display, .item-view .item-percentage-display').forEach(el => {
                el.classList.add('hidden');
            });
            document.querySelectorAll('.item-view .item-code-edit, .item-view .item-description-edit, .item-view .item-quantity-edit, .item-view .item-amount-edit, .item-view .item-due-date-edit, .item-view .item-status-edit, .item-view .item-percentage-edit').forEach(el => {
                el.classList.remove('hidden');
            });
            
            editControls.classList.remove('hidden');
            addItemRow.classList.remove('hidden');
            editBtnText.textContent = 'Cancel Edit';
        } else {
            editSections.forEach(section => {
                if (section.id.includes('-view')) {
                    section.classList.remove('hidden');
                } else if (section.id.includes('-edit')) {
                    section.classList.add('hidden');
                }
            });
            
            // Hide edit inputs in table
            document.querySelectorAll('.item-view .item-code-display, .item-view .item-description-display, .item-view .item-quantity-display, .item-view .item-amount-display, .item-view .item-due-date-display, .item-view .item-status-display, .item-view .item-percentage-display').forEach(el => {
                el.classList.remove('hidden');
            });
            document.querySelectorAll('.item-view .item-code-edit, .item-view .item-description-edit, .item-view .item-quantity-edit, .item-view .item-amount-edit, .item-view .item-due-date-edit, .item-view .item-status-edit, .item-view .item-percentage-edit').forEach(el => {
                el.classList.add('hidden');
            });
            
            editControls.classList.add('hidden');
            addItemRow.classList.add('hidden');
            editBtnText.textContent = 'Edit Invoice';
        }
    }

    // Restore original data
    function restoreOriginalData() {
        if (originalData.clientName !== undefined) {
            document.getElementById('edit-client-name').value = originalData.clientName;
            document.getElementById('edit-client-address').value = originalData.clientAddress;
            document.getElementById('edit-client-tin').value = originalData.clientTin;
            document.getElementById('edit-issue-date').value = originalData.issueDate;
            document.getElementById('edit-due-date').value = originalData.dueDate;
            document.getElementById('edit-payment-terms').value = originalData.paymentTerms;
            document.getElementById('edit-reference-no').value = originalData.referenceNo;
            
            // Restore item data
            document.querySelectorAll('.item-row').forEach((row, index) => {
                if (originalData.items[index]) {
                    const item = originalData.items[index];
                    row.querySelector('.item-code-edit').value = item.code;
                    row.querySelector('.item-description-edit').value = item.description;
                    row.querySelector('.item-quantity-edit').value = item.quantity;
                    row.querySelector('.item-amount-edit').value = item.amount;
                    row.querySelector('.item-due-date-edit').value = item.dueDate;
                    row.querySelector('.item-status-edit').value = item.status;
                    row.querySelector('.item-percentage-edit').value = item.percentage;
                }
            });
        }
    }

    // Check if financial data has changed
    function hasFinancialChanges() {
        let currentAmounts = [];
        document.querySelectorAll('.item-row').forEach((row) => {
            const amount = row.querySelector('.item-amount-edit')?.value || '';
            currentAmounts.push(parseFloat(amount) || 0);
        });
        
        if (currentAmounts.length !== originalData.originalAmounts.length) {
            return true; // Different number of items
        }
        
        for (let i = 0; i < currentAmounts.length; i++) {
            if (Math.abs(currentAmounts[i] - originalData.originalAmounts[i]) > 0.01) {
                return true; // Amount changed significantly
            }
        }
        
        return false;
    }
    
    // Save all changes
    function saveAllChanges() {
        const formData = new FormData();
        
        // Add CSRF token
        formData.append('csrfmiddlewaretoken', csrftoken);
        
        // Add a flag to indicate if this is a financial change
        formData.append('financial_change', hasFinancialChanges() ? 'true' : 'false');
        
        // Add bill-to data (with null checks)
        const clientName = document.getElementById('edit-client-name');
        const clientAddress = document.getElementById('edit-client-address');
        const clientTin = document.getElementById('edit-client-tin');
        
        if (clientName) formData.append('client_name', clientName.value);
        if (clientAddress) formData.append('client_address', clientAddress.value);
        if (clientTin) formData.append('client_tin', clientTin.value);
        
        // Add billing details (with null checks)
        const issueDate = document.getElementById('edit-issue-date');
        const dueDate = document.getElementById('edit-due-date');
        const paymentTerms = document.getElementById('edit-payment-terms');
        const referenceNo = document.getElementById('edit-reference-no');
        
        if (issueDate) formData.append('issue_date', issueDate.value);
        if (dueDate) formData.append('due_date', dueDate.value);
        if (paymentTerms) formData.append('payment_terms', paymentTerms.value);
        if (referenceNo) formData.append('reference_no', referenceNo.value);
        
        // Add items data (with better error handling)
        document.querySelectorAll('.item-row').forEach((row, index) => {
            const itemNum = index + 1;
            
            const itemCode = row.querySelector('.item-code-edit');
            const description = row.querySelector('.item-description-edit');
            const quantity = row.querySelector('.item-quantity-edit');
            const amount = row.querySelector('.item-amount-edit');
            const itemDueDate = row.querySelector('.item-due-date-edit');
            const status = row.querySelector('.item-status-edit');
            const percentage = row.querySelector('.item-percentage-edit');
            
            if (itemCode) formData.append(`item_code_${itemNum}`, itemCode.value || '');
            if (description) formData.append(`description_${itemNum}`, description.value || '');
            if (quantity) formData.append(`quantity_${itemNum}`, quantity.value || '1');
            if (amount) formData.append(`amount_${itemNum}`, amount.value || '0');
            if (itemDueDate) formData.append(`due_date_${itemNum}`, itemDueDate.value || '');
            if (status) formData.append(`status_${itemNum}`, status.value || 'Pending');
            if (percentage) formData.append(`percentage_${itemNum}`, percentage.value || '0');
        });
        
        // Debug: Log form data
        console.log('Form data being sent:');
        for (let [key, value] of formData.entries()) {
            console.log(key, value);
        }
        
        // Send to unified update endpoint
        fetch(`{% url 'update_invoice' invoice.id %}`, {
            method: 'POST',
            headers: {
                'X-CSRFToken': csrftoken,
            },
            body: formData
        })
        .then(response => {
            if (response.ok) {
                showAlert('Invoice updated successfully!');
                // Only reload if there were financial changes to update calculations
                if (hasFinancialChanges()) {
                    setTimeout(() => location.reload(), 1000);
                } else {
                    // For non-financial changes, just exit edit mode
                    setTimeout(() => {
                        toggleEditMode();
                    }, 1000);
                }
            } else {
                response.text().then(text => {
                    console.error('Server response:', text);
                    showAlert('Error updating invoice. Please try again.', 'error');
                });
            }
        })
        .catch(error => {
            console.error('Network error:', error);
            showAlert('Network error. Please try again.', 'error');
        });
    }

    // Add new item row
    function addItemRow() {
        const tbody = document.getElementById('items-table-body');
        const itemCount = tbody.querySelectorAll('.item-row').length + 1;
        const newRow = document.createElement('tr');
        newRow.className = 'bg-white item-row';
        newRow.setAttribute('data-item-id', itemCount);
        
        newRow.innerHTML = `
            <td class="p-3 border-b border-gray-200 item-view">
                <span class="item-code-display">NEW</span>
                <input type="text" class="item-code-edit hidden w-full px-1 py-0.5 text-xs border border-gray-300 rounded" value="NEW">
            </td>
            <td class="p-3 border-b border-gray-200 item-view">
                <span class="item-description-display">New Item</span>
                <textarea class="item-description-edit hidden w-full px-1 py-0.5 text-xs border border-gray-300 rounded" rows="2">New Item</textarea>
            </td>
            <td class="p-3 text-center border-b border-gray-200 item-view">
                <span class="item-quantity-display">1</span>
                <input type="number" class="item-quantity-edit hidden w-full px-1 py-0.5 text-xs border border-gray-300 rounded text-center" value="1">
            </td>
            <td class="p-3 text-right font-semibold text-gray-800 border-b border-gray-200 item-view">
                <span class="item-amount-display">₱ 0.00</span>
                <input type="number" step="0.01" class="item-amount-edit hidden w-full px-1 py-0.5 text-xs border border-gray-300 rounded text-right" value="0">
            </td>
            <td class="p-3 text-center border-b border-gray-200 item-view">
                <span class="item-due-date-display">-</span>
                <input type="date" class="item-due-date-edit hidden w-full px-1 py-0.5 text-xs border border-gray-300 rounded" value="">
            </td>
            <td class="p-3 text-center border-b border-gray-200 item-view">
                <span class="item-status-display">
                    <span class="inline-block px-2 py-0.5 text-xs font-semibold rounded-full bg-yellow-100 text-yellow-800">Pending</span>
                </span>
                <select class="item-status-edit hidden w-full px-1 py-0.5 text-xs border border-gray-300 rounded">
                    <option value="Pending" selected>Pending</option>
                    <option value="Received">Received</option>
                    <option value="Overdue">Overdue</option>
                </select>
            </td>
            <td class="p-3 text-center font-medium border-b border-gray-200 item-view">
                <span class="item-percentage-display">0.00%</span>
                <input type="number" step="0.01" min="0" max="100" class="item-percentage-edit hidden w-full px-1 py-0.5 text-xs border border-gray-300 rounded text-center" value="0">
            </td>
            <td class="p-3 text-center border-b border-gray-200">
                <button type="button" onclick="removeItemRow(this)" class="text-red-600 hover:text-red-800 text-sm font-medium edit-mode-only hidden">
                    Remove
                </button>
            </td>
        `;
        
        tbody.appendChild(newRow);
        
        // Show edit fields for the new row
        toggleEditMode();
    };

    document.getElementById('save-all-btn').addEventListener('click', saveAllChanges);
    
    // Event Listeners
    document.getElementById('toggle-edit-btn').addEventListener('click', function() {
        if (isEditMode) {
            restoreOriginalData();
        }
        toggleEditMode();
    });
    
    document.getElementById('cancel-all-btn').addEventListener('click', function() {
        restoreOriginalData();
        toggleEditMode();
    });
    
    document.getElementById('add-item-btn').addEventListener('click', addItemRow);

    // Function to sync signatures across all three roles
    function syncSignaturesAcrossRoles(uploadedSignatureUrl) {
        document.getElementById('signature-prepared_by').src = uploadedSignatureUrl;
        document.getElementById('signature-checked_by').src = uploadedSignatureUrl;
        document.getElementById('signature-approved_by').src = uploadedSignatureUrl;
    }

    // Function to clear all signatures
    function clearAllSignatures() {
        const placeholderUrl = "{% static 'media/placeholder.png' %}";
        document.getElementById('signature-prepared_by').src = placeholderUrl;
        document.getElementById('signature-checked_by').src = placeholderUrl;
        document.getElementById('signature-approved_by').src = placeholderUrl;
    }

    document.querySelectorAll('.signature-container').forEach(container => {
        const role = container.dataset.role;
        const uploadInput = document.getElementById(`signature-upload-${role}`);
        const clearButton = container.querySelector('.clear-signature-btn');

        if (uploadInput) {
            uploadInput.addEventListener('change', function() {
                if (this.files && this.files[0]) {
                    const formData = new FormData();
                    formData.append('signature_image', this.files[0]);

                    fetch(`{% url 'upload_signature' invoice.id 'role_placeholder' %}`.replace('role_placeholder', role), {
                        method: 'POST',
                        headers: {
                            'X-CSRFToken': csrftoken,
                        },
                        body: formData
                    })
                    .then(response => response.json())
                    .then(data => {
                        if (data.success) {
                            syncSignaturesAcrossRoles(data.signature_url);
                            showAlert('Signature uploaded successfully.');
                        } else {
                            showAlert(data.error, 'error');
                        }
                    })
                    .catch(error => showAlert('An error occurred.', 'error'));
                }
            });
        }

        if (clearButton) {
            clearButton.addEventListener('click', function() {
                fetch(`{% url 'upload_signature' invoice.id 'role_placeholder' %}`.replace('role_placeholder', role), {
                    method: 'POST',
                    headers: {
                        'X-CSRFToken': csrftoken,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ action: 'clear' })
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        clearAllSignatures();
                        showAlert('Signature cleared.');
                    } else {
                        showAlert(data.error, 'error');
                    }
                })
                .catch(error => showAlert('An error occurred.', 'error'));
            });
        }
    });
});
</script>

  

  <script>
    // --- Add interactivity & PDF download ---
    document.addEventListener('DOMContentLoaded', function () {
      // Fade-in animation for invoice container
      const invoiceElem = document.querySelector('.max-w-5xl');
      if (invoiceElem) {
        invoiceElem.style.opacity = '0';
        invoiceElem.animate([{ opacity: 0 }, { opacity: 1 }], { duration: 500, fill: 'forwards' });
      }

      // Hover scale effect for action buttons/links
      document.querySelectorAll('.no-print button, .no-print a').forEach(btn => {
        btn.addEventListener('mouseover', () => btn.classList.add('scale-105'));
        btn.addEventListener('mouseout', () => btn.classList.remove('scale-105'));
      });

      // Download PDF via server-side generation
      window.printInvoice = async function printInvoice() {
        const downloadBtn = document.getElementById('downloadPdf');
        const originalText = downloadBtn.innerHTML;
        
        try {
          // Show loading state
          downloadBtn.disabled = true;
          downloadBtn.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i> Generating PDF...';
          
          // Create a hidden link to trigger download
          const downloadLink = document.createElement('a');
          downloadLink.style.display = 'none';
          document.body.appendChild(downloadLink);
          
          // Fetch the PDF with credentials
          const response = await fetch(`{% url 'invoice_pdf' invoice.id %}`, {
            credentials: 'same-origin',
            headers: {
              'X-Requested-With': 'XMLHttpRequest',
              'X-CSRFToken': '{{ csrf_token }}'
            }
          });
          
          if (!response.ok) {
            throw new Error(`HTTP error! status: ${response.status}`);
          }
          
          // Create blob and download
          const blob = await response.blob();
          const url = window.URL.createObjectURL(blob);
          downloadLink.href = url;
          downloadLink.download = `invoice_{{ invoice.invoice_no }}.pdf`;
          downloadLink.click();
          
          // Clean up
          window.URL.revokeObjectURL(url);
          document.body.removeChild(downloadLink);
          
        } catch (error) {
          console.error('Error generating PDF:', error);
          alert('Failed to generate PDF. Please try again or contact support.');
        } finally {
          // Reset button state
          downloadBtn.disabled = false;
          downloadBtn.innerHTML = originalText;
        }
      };

      // --- Edit Bill To Modal Logic ---
      const editBtn = document.getElementById('edit-bill-to-btn');
      const modal = document.getElementById('edit-bill-to-modal');
      const cancelBtn = document.getElementById('cancel-edit-btn');
      const closeBtn = document.getElementById('close-modal-btn');
      const saveBtn = document.getElementById('save-changes-btn');
      const form = document.getElementById('bill-to-form');

      if (editBtn && modal && cancelBtn && closeBtn && saveBtn && form) {
        const openModal = () => modal.classList.remove('hidden');
        const closeModal = () => modal.classList.add('hidden');

        editBtn.addEventListener('click', openModal);
        cancelBtn.addEventListener('click', closeModal);
        closeBtn.addEventListener('click', closeModal);
        
        window.addEventListener('click', (event) => {
          if (event.target === modal) {
            closeModal();
          }
        });

        saveBtn.addEventListener('click', () => {
          form.submit();
        });
      }

      // --- Edit Billing Details Modal Logic ---
      const editBillingBtn = document.getElementById('edit-billing-details-btn');
      const billingModal = document.getElementById('edit-billing-details-modal');
      const cancelBillingBtn = document.getElementById('cancel-billing-details-btn');
      const closeBillingBtn = document.getElementById('close-billing-details-modal-btn');
      const saveBillingBtn = document.getElementById('save-billing-details-btn');
      const billingForm = document.getElementById('billing-details-form');

      if (editBillingBtn && billingModal && cancelBillingBtn && closeBillingBtn && saveBillingBtn && billingForm) {
        const openBillingModal = () => billingModal.classList.remove('hidden');
        const closeBillingModal = () => billingModal.classList.add('hidden');

        editBillingBtn.addEventListener('click', openBillingModal);
        cancelBillingBtn.addEventListener('click', closeBillingModal);
        closeBillingBtn.addEventListener('click', closeBillingModal);
        
        window.addEventListener('click', (event) => {
          if (event.target === billingModal) {
            closeBillingModal();
          }
        });

        saveBillingBtn.addEventListener('click', () => {
          billingForm.submit();
        });
      }

      // --- Edit Items Modal Logic ---
      const editItemsBtn = document.getElementById('edit-items-btn');
      const itemsModal = document.getElementById('edit-items-modal');
      const cancelItemsBtn = document.getElementById('cancel-items-btn');
      const closeItemsBtn = document.getElementById('close-items-modal-btn');
      const saveItemsBtn = document.getElementById('save-items-btn');
      const itemsForm = document.getElementById('items-form');
      const addItemBtn = document.getElementById('add-item-btn');
      const itemsTableBody = document.getElementById('items-table-body');
      let itemCounter = 1;

      if (editItemsBtn && itemsModal && cancelItemsBtn && closeItemsBtn && saveItemsBtn && itemsForm) {
        const openItemsModal = () => itemsModal.classList.remove('hidden');
        const closeItemsModal = () => itemsModal.classList.add('hidden');

        editItemsBtn.addEventListener('click', openItemsModal);
        cancelItemsBtn.addEventListener('click', closeItemsModal);
        closeItemsBtn.addEventListener('click', closeItemsModal);
        
        window.addEventListener('click', (event) => {
          if (event.target === itemsModal) {
            closeItemsModal();
          }
        });

        saveItemsBtn.addEventListener('click', () => {
          itemsForm.submit();
        });

        // Add new item functionality
        if (addItemBtn) {
          addItemBtn.addEventListener('click', () => {
            itemCounter++;
            const newRow = document.createElement('tr');
            newRow.className = 'item-row';
            newRow.innerHTML = `
              <td class="p-3 border-b border-gray-200">
                <input type="text" name="item_code_${itemCounter}" value="DPC" class="w-full px-2 py-1 border border-gray-300 rounded text-sm">
              </td>
              <td class="p-3 border-b border-gray-200">
                <textarea name="description_${itemCounter}" rows="2" class="w-full px-2 py-1 border border-gray-300 rounded text-sm">Commission Payment</textarea>
              </td>
              <td class="p-3 border-b border-gray-200">
                <input type="number" name="quantity_${itemCounter}" value="1" class="w-full px-2 py-1 border border-gray-300 rounded text-sm text-center" min="1">
              </td>
              <td class="p-3 border-b border-gray-200">
                <input type="number" name="amount_${itemCounter}" value="0.00" step="0.01" class="w-full px-2 py-1 border border-gray-300 rounded text-sm text-right amount-input">
              </td>
              <td class="p-3 border-b border-gray-200">
                <input type="date" name="due_date_${itemCounter}" class="w-full px-2 py-1 border border-gray-300 rounded text-sm">
              </td>
              <td class="p-3 border-b border-gray-200">
                <select name="status_${itemCounter}" class="w-full px-2 py-1 border border-gray-300 rounded text-sm">
                  <option value="Pending">Pending</option>
                  <option value="Received">Received</option>
                  <option value="Overdue">Overdue</option>
                </select>
              </td>
              <td class="p-3 border-b border-gray-200">
                <input type="number" name="percentage_${itemCounter}" value="0.00" step="0.01" min="0" max="100" class="w-full px-2 py-1 border border-gray-300 rounded text-sm text-center percentage-input">
              </td>
              <td class="p-3 border-b border-gray-200 text-center">
                <button type="button" class="remove-item-btn text-red-500 hover:text-red-700" title="Remove Item">
                  <i class="fas fa-trash"></i>
                </button>
              </td>
            `;
            itemsTableBody.appendChild(newRow);
            updateTotalAmount();
            attachItemEventListeners(newRow);
          });
        }

        // Remove item functionality
        function attachItemEventListeners(row) {
          const removeBtn = row.querySelector('.remove-item-btn');
          const amountInput = row.querySelector('.amount-input');
          const percentageInput = row.querySelector('.percentage-input');

          if (removeBtn) {
            removeBtn.addEventListener('click', () => {
              if (itemsTableBody.children.length > 1) {
                row.remove();
                updateTotalAmount();
              } else {
                alert('At least one item is required.');
              }
            });
          }

          if (amountInput) {
            amountInput.addEventListener('input', updateTotalAmount);
          }

          if (percentageInput) {
            percentageInput.addEventListener('input', validatePercentage);
          }
        }

        // Update total amount calculation
        function updateTotalAmount() {
          const amountInputs = document.querySelectorAll('.amount-input');
          let total = 0;
          amountInputs.forEach(input => {
            const value = parseFloat(input.value) || 0;
            total += value;
          });
          document.getElementById('total-amount-display').textContent = total.toFixed(2);
        }

        // Validate percentage inputs
        function validatePercentage() {
          const percentageInputs = document.querySelectorAll('.percentage-input');
          let total = 0;
          percentageInputs.forEach(input => {
            const value = parseFloat(input.value) || 0;
            total += value;
          });
          
          if (total > 100) {
            alert('Total percentage cannot exceed 100%');
            // Reset the last changed input
            event.target.value = '';
          }
        }

        // Initialize event listeners for existing rows
        document.querySelectorAll('.item-row').forEach(row => {
          attachItemEventListeners(row);
        });
      }
      
    });
    
  </script>
</body>
</html>
<script>
  function getCookie(name) {
      let cookieValue = null;
      if (document.cookie && document.cookie !== '') {
          const cookies = document.cookie.split(';');
          for (let i = 0; i < cookies.length; i++) {
              const cookie = cookies[i].trim();
              if (cookie.substring(0, name.length + 1) === (name + '=')) {
                  cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                  break;
              }
          }
      }
      return cookieValue;
  }
  const csrftoken = getCookie('csrftoken');

  document.getElementById('emailInvoiceBtn').addEventListener('click', function() {
      const recipientEmail = prompt("Please enter the recipient's email address:", "");
      if (recipientEmail) {
          if (!/^\S+@\S+\.\S+$/.test(recipientEmail)) {
              showAlert('Invalid email address format.', 'error');
              return;
          }

          const url = `{% url 'email_invoice' invoice.id %}`;
          
          fetch(url, {
              method: 'POST',
              headers: {
                  'Content-Type': 'application/x-www-form-urlencoded',
                  'X-CSRFToken': csrftoken
              },
              body: 'email=' + encodeURIComponent(recipientEmail)
          })
          .then(response => response.json())
          .then(data => {
              if (data.status === 'success') {
                  showAlert(data.message, 'success');
              } else {
                  showAlert(data.message, 'error');
              }
          })
          .catch(error => {
              console.error('Error:', error);
              showAlert('An unexpected error occurred. Please try again.', 'error');
          });
      }
  });

  function showAlert(message, type) {
      const container = document.getElementById('alert-container');
      const bgColor = type === 'success' ? 'bg-green-100 border-green-400 text-green-700' : 'bg-red-100 border-red-400 text-red-700';
      const alertDiv = document.createElement('div');
      alertDiv.className = `border px-4 py-3 rounded relative ${bgColor}`;
      alertDiv.setAttribute('role', 'alert');
      alertDiv.innerHTML = `<span class="block sm:inline">${message}</span>`;
      
      container.innerHTML = ''; // Clear previous alerts
      container.appendChild(alertDiv);

      setTimeout(() => {
          alertDiv.remove();
      }, 5000);
  }

  // Signature upload functionality
  document.querySelectorAll('input[type="file"][id^="signature-upload-"]').forEach(input => {
      input.addEventListener('change', function(e) {
          e.preventDefault();
          e.stopPropagation();
          
          const file = e.target.files[0];
          if (!file) return;
          
          const role = this.id.replace('signature-upload-', '');
          
          // Immediately show a preview in only the correct container
          const reader = new FileReader();
          reader.onload = function(event) {
              const targetImg = document.getElementById(`signature-${role}`);
              if (targetImg) {
                  targetImg.src = event.target.result;
              }
          };
          reader.readAsDataURL(file);
          
          const formData = new FormData();
          formData.append('signature', file);
          formData.append('csrfmiddlewaretoken', csrftoken);
          
          fetch(`/invoice/{{ invoice.id }}/upload-signature/${role}/`, {
              method: 'POST',
              body: formData
          })
          .then(response => response.json())
          .then(data => {
              if (data.success) {
                  showAlert(data.message, 'success');
                  
                  // Update with the server URL
                  const targetImg = document.getElementById(`signature-${role}`);
                  if (targetImg && data.signature_url) {
                      targetImg.src = data.signature_url + '?v=' + Date.now();
                  }
              } else {
                  showAlert(data.error, 'error');
                  // Revert to placeholder on error
                  const targetImg = document.getElementById(`signature-${role}`);
                  if (targetImg) {
                      targetImg.src = "{% static 'media/placeholder.png' %}";
                  }
              }
              
              // Reset the file input
              e.target.value = '';
          })
          .catch(error => {
              console.error('Error:', error);
              showAlert('Error uploading signature', 'error');
              // Revert to placeholder on error
              const targetImg = document.getElementById(`signature-${role}`);
              if (targetImg) {
                  targetImg.src = "{% static 'media/placeholder.png' %}";
              }
              e.target.value = '';
          });
      });
  });

  // Clear signature functionality
  document.querySelectorAll('.clear-signature-btn').forEach(button => {
      button.addEventListener('click', function(e) {
          const container = this.closest('.signature-container');
          const role = container.dataset.role;
          
          if (!confirm('Are you sure you want to clear this signature?')) return;
          
          const formData = new FormData();
          formData.append('action', 'clear');
          formData.append('csrfmiddlewaretoken', csrftoken);
          
          fetch(`/invoice/{{ invoice.id }}/upload-signature/${role}/`, {
              method: 'POST',
              body: formData
          })
          .then(response => response.json())
          .then(data => {
              if (data.success) {
                  showAlert(data.message, 'success');
                  // Reset only the specific role's signature image to placeholder
                  const signatureImg = document.getElementById(`signature-${role}`);
                  if (signatureImg) {
                      signatureImg.src = "{% static 'media/placeholder.png' %}";
                  }
              } else {
                  showAlert(data.error, 'error');
              }
          })
          .catch(error => {
              console.error('Error:', error);
              showAlert('Error clearing signature', 'error');
          });
      });
  });
</script>
{% endblock %}