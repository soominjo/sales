{% extends "index.html" %}

{% load widget_tweaks %}

{% load humanize %}

{% block content %}

{% load static %}

<head>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
</head>

<div class="min-h-screen bg-gray-50 py-6 px-4 sm:px-6 lg:px-8">
    <div class="max-w-6xl mx-auto">
        <!-- Header Card -->
        <div class="bg-gradient-to-r from-blue-700 to-indigo-800 rounded-2xl shadow-xl overflow-hidden mb-8">
            <div class="p-6 md:p-8">
                <div class="flex flex-col md:flex-row items-center space-y-6 md:space-y-0 md:space-x-8">
                    <div class="bg-white p-3 rounded-2xl shadow-lg">
                        <img src="{% static 'media/LOGO.png' %}" alt="Company Logo" class="w-16 h-16 md:w-20 md:h-20 object-contain">
                    </div>
                    <div class="text-center md:text-left text-white">
                        <h2 class="text-2xl md:text-3xl font-bold mb-2">Inner SPARC Realty Corporation</h2>
                        <div class="text-sm md:text-base space-y-1 opacity-90">
                            <p>Main Office: Block 26 Lot 4 Phase 3 Avida Residences Sta. Catalina</p>
                            <p>Salawag, Dasmariñas, Cavite 4114</p>
                            <p>63917-853-4875/63999-994-3304/(046)458 0706</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Main Form -->
        <div class="bg-white rounded-2xl shadow-xl p-6 md:p-8">
            <h1 class="text-2xl md:text-3xl font-bold text-center text-gray-800 mb-6">
                <span class="bg-clip-text text-transparent bg-gradient-to-r from-blue-600 to-indigo-600">
                    Create Management Commission Slip
                </span>
            </h1>

            <!-- Commission Slip Type Selector -->
            <div class="flex justify-center mb-8">
                <div class="flex rounded-xl shadow-sm bg-gray-100 p-1 gap-1">
                    {% if user.is_superuser or user.is_staff %}
                        <a href="{% url 'create_commission_slip' %}" class="px-4 py-2 text-sm font-medium text-gray-700 bg-white rounded-lg hover:bg-gray-50 transition-colors">Agent</a>
                        <a href="{% url 'create_commission_slip2' %}" class="px-4 py-2 text-sm font-medium text-white bg-blue-600 rounded-lg">Management</a>
                        <a href="{% url 'create_commission_slip3' %}" class="px-4 py-2 text-sm font-medium text-gray-700 bg-white rounded-lg hover:bg-gray-50 transition-colors">Supervisor-Agent</a>
                    {% elif user.profile.role == 'Sales Manager' or user.profile.role == 'Sales Supervisor' %}
                        <a href="{% url 'create_commission_slip' %}" class="px-4 py-2 text-sm font-medium text-gray-700 bg-white rounded-lg hover:bg-gray-50 transition-colors">Agent</a>
                        <a href="{% url 'create_commission_slip3' %}" class="px-4 py-2 text-sm font-medium text-gray-700 bg-white rounded-lg hover:bg-gray-50 transition-colors">Supervisor-Agent</a>
                    {% endif %}
                </div>
            </div>

            {% if slip_form.errors %}
                <div class="bg-red-100 border border-red-400 text-red-700 px-4 py-3 rounded-lg relative mb-6" role="alert">
                    <strong class="font-bold">Error!</strong>
                    <span class="block sm:inline">Please correct the following errors:</span>
                    <ul class="list-disc list-inside mt-2">
                        {% for field, errors in slip_form.errors.items %}
                            {% for error in errors %}
                                <li><strong>{{ field|title }}:</strong> {{ error }}</li>
                            {% endfor %}
                        {% endfor %}
                    </ul>
                </div>
            {% endif %}

            <form method="POST" action="{% url 'create_commission_slip2' %}" class="space-y-8">
                {% csrf_token %}

                <!-- Project Details Section -->
                <div class="bg-blue-50 rounded-2xl p-6 border border-blue-100">
                    <div class="flex items-center mb-6">
                        <div class="h-8 w-1 bg-blue-600 rounded-full mr-3"></div>
                        <h2 class="text-xl font-semibold text-gray-800">Project Details</h2>
                    </div>
                    
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        {% if user.is_superuser or user.is_staff %}
                        <div>
                            <label for="agent_select" class="block text-sm font-medium text-gray-700 mb-2"><i class="fas fa-user-tie mr-2 text-blue-500"></i>Select Sales Manager</label>
                            <select name="agent_select" id="agent_select" class="w-full p-3 border border-gray-200 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 bg-white shadow-sm" onchange="updateAgentInfo()">
                                <option value="">Select a Sales Manager</option>
                                {% for user in active_users %}
                                    {% if user.profile.role == 'Sales Manager' %}
                                        <option value="{{ user.id }}" data-name="{{ user.get_full_name }}" data-position="{{ user.profile.role }}">
                                            {{ user.get_full_name }} ({{ user.profile.team.display_name }})
                                        </option>
                                    {% endif %}
                                {% endfor %}
                            </select>
                        </div>
                        {% endif %}
                        
                        <div>
                            <label for="sales_agent_name" class="block text-sm font-medium text-gray-700 mb-2"><i class="fas fa-signature mr-2 text-blue-500"></i>Name</label>
                            <input type="text" id="agent_name_display" readonly class="w-full p-3 border border-gray-200 rounded-lg bg-gray-50 shadow-sm">
                        </div>
                        <br>
                        
                        <div>
                            <label for="position" class="block text-sm font-medium text-gray-700 mb-2"><i class="fas fa-user-tag mr-2 text-blue-500"></i>Position</label>
                            <input type="text" id="position_display" readonly class="w-full p-3 border border-gray-200 rounded-lg bg-gray-50 shadow-sm">
                        </div>

                       

                        <div>
                            <label for="buyer_name" class="block text-sm font-medium text-gray-700 mb-2"><i class="fas fa-user mr-2 text-blue-500"></i>Buyer Name</label>
                            {{ slip_form.buyer_name|add_class:"w-full p-3 border border-gray-200 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 shadow-sm" }}
                        </div>

                        <div>
                            <label for="project_name" class="block text-sm font-medium text-gray-700 mb-2"><i class="fas fa-building mr-2 text-blue-500"></i>Project Name</label>
                            <select name="project_name" id="project_name" class="w-full p-3 border border-gray-200 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 shadow-sm bg-white" required>
                                <option value="">Select a project</option>
                                {% for property in properties %}
                                    <option value="{{ property.name }}">{{ property.name }}{% if property.developer %} - {{ property.developer.name }}{% endif %}</option>
                                {% endfor %}
                            </select>
                        </div>

                        <div>
                            <label for="unit_id" class="block text-sm font-medium text-gray-700 mb-2"><i class="fas fa-home mr-2 text-blue-500"></i>Unit ID</label>
                            {{ slip_form.unit_id|add_class:"w-full p-3 border border-gray-200 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 shadow-sm" }}
                        </div>
                    </div>
                </div>

                <!-- Commission Details Section -->
                <div class="bg-blue-50 rounded-2xl p-6 border border-blue-100">
                    <div class="flex items-center mb-6">
                        <div class="h-8 w-1 bg-blue-600 rounded-full mr-3"></div>
                        <h2 class="text-xl font-semibold text-gray-800">Commission Details</h2>
                    </div>
                    
                    <div class="space-y-6">
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                            <div>
                                <label for="total_selling_price" class="block text-sm font-medium text-gray-700 mb-2"><i class="fas fa-money-bill-wave mr-2 text-blue-500"></i>Total Selling Price</label>
                                <div class="relative">
                                    <span class="absolute left-3 top-3 text-gray-500">₱</span>
                                    <input type="number" step="0.01" name="total_selling_price" id="total_selling_price" class="w-full p-3 pl-8 border border-gray-200 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 shadow-sm" placeholder="Enter amount" required onchange="updateCommissionPreview()">
                                </div>
                            </div>

                            <div>
                                <label for="manager_commission_rate" class="block text-sm font-medium text-gray-700 mb-2"><i class="fas fa-percent mr-2 text-blue-500"></i>Manager Commission Rate</label>
                                <div class="relative">
                                    <input type="number" step="0.01" name="manager_commission_rate" id="manager_commission_rate" value="3.00" class="w-full p-3 pr-8 border border-gray-200 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 shadow-sm" placeholder="Enter rate" required onchange="updateCommissionPreview()">
                                    <span class="absolute right-3 top-3 text-gray-500">%</span>
                                </div>
                            </div>

                            <div>
                                <label for="particulars" class="block text-sm font-medium text-gray-700 mb-2"><i class="fas fa-list mr-2 text-blue-500"></i>Particulars</label>
                                <select name="particulars" id="particulars" class="w-full p-3 border border-gray-200 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 shadow-sm bg-white" onchange="updateFieldsVisibility(); updateCommissionPreview();">
                                    <option value="FULL COMM">FULL COMM</option>
                                    <option value="PARTIAL COMM">PARTIAL COMM</option>
                                    <option value="INCENTIVES">INCENTIVES</option>
                                    <option value="CASH ADVANCE">CASH ADVANCE</option>
                                </select>
                            </div>
                            
                            <div class="cash-advance-field" style="display: none;">
                                <label for="cash_advance" class="block text-sm font-medium text-gray-700 mb-2"><i class="fas fa-money-check mr-2 text-blue-500"></i>Cash Advance</label>
                                <div class="relative">
                                    <span class="absolute left-3 top-3 text-gray-500">₱</span>
                                    <input type="number" step="0.01" name="cash_advance" id="cash_advance" class="w-full p-3 pl-8 border border-gray-200 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 shadow-sm" placeholder="Enter cash advance amount" value="0" onchange="updateCommissionPreview()">
                                </div>
                            </div>

                            <div class="partial-field col-span-2" style="display: none;">
                                <label for="partial_percentage" class="block text-sm font-medium text-gray-700 mb-2"><i class="fas fa-chart-pie mr-2 text-blue-500"></i>Percentage of Commission Amount</label>
                                <div class="relative">
                                    <input type="number" step="0.01" name="partial_percentage" id="partial_percentage" value="100" class="w-full p-3 pr-8 border border-gray-200 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 shadow-sm" placeholder="Enter percentage" onchange="updateCommissionPreview()">
                                    <span class="absolute right-3 top-3 text-gray-500">%</span>
                                </div>
                                <p class="text-sm text-gray-500 mt-1">This percentage will be applied to all commission amounts</p>
                            </div>
                        </div>

                        <div id="positions-container">
                            <!-- Hidden fields for positions will be added here by JS -->
                        </div>

                        <div class="bg-white rounded-lg p-4 border border-gray-200">
                            <h3 class="text-lg font-medium text-gray-700 mb-4">Other Position Commission Rates</h3>
                            <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">Operation Manager</label>
                                    <div class="relative">
                                        <input type="number" name="commission_rate" id="om_rate" step="0.01" class="w-full p-3 pr-8 border border-gray-200 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 shadow-sm" placeholder="Rate" onchange="updateCommissionPreview()">
                                        <span class="absolute right-3 top-3 text-gray-500">%</span>
                                    </div>
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">Co-Founder</label>
                                    <div class="relative">
                                        <input type="number" name="commission_rate" id="cf_rate" step="0.01" class="w-full p-3 pr-8 border border-gray-200 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 shadow-sm" placeholder="Rate" onchange="updateCommissionPreview()">
                                        <span class="absolute right-3 top-3 text-gray-500">%</span>
                                    </div>
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">Founder</label>
                                    <div class="relative">
                                        <input type="number" name="commission_rate" id="founder_rate" step="0.01" class="w-full p-3 pr-8 border border-gray-200 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 shadow-sm" placeholder="Rate" onchange="updateCommissionPreview()">
                                        <span class="absolute right-3 top-3 text-gray-500">%</span>
                                    </div>
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">Funds</label>
                                    <div class="relative">
                                        <input type="number" name="commission_rate" id="funds_rate" step="0.01" class="w-full p-3 pr-8 border border-gray-200 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 shadow-sm" placeholder="Rate" onchange="updateCommissionPreview()">
                                        <span class="absolute right-3 top-3 text-gray-500">%</span>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                            <div>
                                <label for="date" class="block text-sm font-medium text-gray-700 mb-2"><i class="fas fa-calendar-alt mr-2 text-blue-500"></i>Date</label>
                                <input type="date" name="date" id="date" class="w-full p-3 border border-gray-200 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 shadow-sm" required>
                            </div>
                            <div>
                                <label for="withholding_tax_rate" class="block text-sm font-medium text-gray-700 mb-2"><i class="fas fa-file-invoice-dollar mr-2 text-blue-500"></i>Sales Manager Tax Rate</label>
                                <div class="relative">
                                    <input type="number" step="0.01" name="withholding_tax_rate" id="withholding_tax_rate" class="w-full p-3 pr-8 border border-gray-200 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 shadow-sm bg-white" placeholder="Enter tax rate" value="10.00" min="0" max="100" onchange="updateCommissionPreview()" required>
                                    <span class="absolute right-3 top-3 text-gray-500">%</span>
                                </div>
                            </div>
                            <div>
                                <label for="operation_manager_tax_rate" class="block text-sm font-medium text-gray-700 mb-2"><i class="fas fa-file-invoice-dollar mr-2 text-blue-500"></i>Operation Manager Tax Rate</label>
                                <div class="relative">
                                    <input type="number" step="0.01" name="operation_manager_tax_rate" id="operation_manager_tax_rate" class="w-full p-3 pr-8 border border-gray-200 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 shadow-sm bg-white" placeholder="Enter tax rate" value="10.00" min="0" max="100" onchange="updateCommissionPreview()" required>
                                    <span class="absolute right-3 top-3 text-gray-500">%</span>
                                </div>
                            </div>
                            <div>
                                <label for="co_founder_tax_rate" class="block text-sm font-medium text-gray-700 mb-2"><i class="fas fa-file-invoice-dollar mr-2 text-blue-500"></i>Co-Founder Tax Rate</label>
                                <div class="relative">
                                    <input type="number" step="0.01" name="co_founder_tax_rate" id="co_founder_tax_rate" class="w-full p-3 pr-8 border border-gray-200 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 shadow-sm bg-white" placeholder="Enter tax rate" value="10.00" min="0" max="100" onchange="updateCommissionPreview()" required>
                                    <span class="absolute right-3 top-3 text-gray-500">%</span>
                                </div>
                            </div>
                            <div>
                                <label for="founder_tax_rate" class="block text-sm font-medium text-gray-700 mb-2"><i class="fas fa-file-invoice-dollar mr-2 text-blue-500"></i>Founder Tax Rate</label>
                                <div class="relative">
                                    <input type="number" step="0.01" name="founder_tax_rate" id="founder_tax_rate" class="w-full p-3 pr-8 border border-gray-200 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 shadow-sm bg-white" placeholder="Enter tax rate" value="10.00" min="0" max="100" onchange="updateCommissionPreview()" required>
                                    <span class="absolute right-3 top-3 text-gray-500">%</span>
                                </div>
                            </div>
                            <div>
                                <label for="funds_tax_rate" class="block text-sm font-medium text-gray-700 mb-2"><i class="fas fa-file-invoice-dollar mr-2 text-blue-500"></i>Funds Tax Rate</label>
                                <div class="relative">
                                    <input type="number" step="0.01" name="funds_tax_rate" id="funds_tax_rate" class="w-full p-3 pr-8 border border-gray-200 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 shadow-sm bg-white" placeholder="Enter tax rate" value="10.00" min="0" max="100" onchange="updateCommissionPreview()" required>
                                    <span class="absolute right-3 top-3 text-gray-500">%</span>
                                </div>
                            </div>
                        </div>

                        <div class="incentive-field" style="display: none;">
                            <label for="incentive_amount" class="block text-sm font-medium text-gray-700 mb-2"><i class="fas fa-gift mr-2 text-blue-500"></i>Incentive Amount</label>
                            <div class="relative">
                                <span class="absolute left-3 top-3 text-gray-500">₱</span>
                                <input type="number" name="incentive_amount" id="incentive_amount" value="0" class="w-full p-3 pl-8 border border-gray-200 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 shadow-sm" step="0.01" onchange="updateCommissionPreview()">
                            </div>
                        </div>

                        <div class="mt-8 bg-white p-4 rounded-xl border border-gray-200 shadow-sm">
                            <h3 class="text-lg font-medium text-gray-700 mb-4 flex items-center"><i class="fas fa-calculator mr-2 text-blue-500"></i>Commission Breakdown Preview</h3>
                            <div class="overflow-x-auto">
                                <table class="w-full border-collapse rounded-lg overflow-hidden">
                                    <thead class="bg-blue-100">
                                        <tr>
                                            <th class="px-4 py-3 text-left text-xs font-medium text-gray-700 uppercase tracking-wider">Position</th>
                                            <th class="px-4 py-3 text-left text-xs font-medium text-gray-700 uppercase tracking-wider">Rate</th>
                                            <th class="px-4 py-3 text-left text-xs font-medium text-gray-700 uppercase tracking-wider">Percentage</th>
                                            <th class="px-4 py-3 text-left text-xs font-medium text-gray-700 uppercase tracking-wider">Gross Commission</th>
                                            <th class="px-4 py-3 text-left text-xs font-medium text-gray-700 uppercase tracking-wider">Tax</th>
                                            <th class="px-4 py-3 text-left text-xs font-medium text-gray-700 uppercase tracking-wider">Net Commission</th>
                                        </tr>
                                    </thead>
                                    <tbody class="bg-white divide-y divide-gray-200" id="previewTableBody"></tbody>
                                    <tfoot class="bg-blue-50 font-semibold">
                                        <tr id="totalRow">
                                            <td class="px-4 py-3" colspan="3">TOTAL</td>
                                            <td class="px-4 py-3" id="totalGrossCommission">₱0.00</td>
                                            <td class="px-4 py-3" id="totalTax">₱0.00</td>
                                            <td class="px-4 py-3" id="totalNetCommission">₱0.00</td>
                                        </tr>
                                    </tfoot>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Submit and Back Buttons -->
                <div class="flex justify-center items-center gap-4 mt-8">
                    <a href="{% url 'commission_history' %}" class="inline-flex items-center px-6 py-3 border border-gray-300 text-sm font-medium rounded-lg text-gray-700 bg-white hover:bg-gray-50 transition-colors shadow-sm">
                        <i class="fas fa-arrow-left mr-2"></i>
                        Go Back
                    </a>
                    <button type="submit" class="inline-flex items-center px-6 py-3 border border-transparent text-sm font-medium rounded-lg text-white bg-gradient-to-r from-blue-600 to-indigo-600 hover:from-blue-700 hover:to-indigo-700 shadow-lg transform hover:-translate-y-0.5">
                        <i class="fas fa-save mr-2"></i>
                        Save Commission Slip
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<script>
    function formatCurrency(amount) {
        return amount.toLocaleString('en-US', {
            minimumFractionDigits: 2,
            maximumFractionDigits: 2
        });
    }

    function updateFieldsVisibility() {
        const particularsSelect = document.getElementById('particulars');
        const incentiveField = document.querySelector('.incentive-field');
        const partialField = document.querySelector('.partial-field');
        const cashAdvanceField = document.querySelector('.cash-advance-field');
        const selectedValue = particularsSelect.value;

        incentiveField.style.display = selectedValue === 'INCENTIVES' ? 'block' : 'none';
        partialField.style.display = selectedValue === 'PARTIAL COMM' ? 'block' : 'none';
        cashAdvanceField.style.display = selectedValue === 'CASH ADVANCE' ? 'block' : 'none';

        if (selectedValue !== 'PARTIAL COMM') document.getElementById('partial_percentage').value = '100';
        if (selectedValue !== 'INCENTIVES') document.getElementById('incentive_amount').value = '0';
        if (selectedValue !== 'CASH ADVANCE') document.getElementById('cash_advance').value = '0';

        updateCommissionPreview();
    }

    function updateCommissionPreview() {
        const totalSellingPrice = parseFloat(document.getElementById('total_selling_price').value) || 0;
        const cashAdvance = parseFloat(document.getElementById('cash_advance').value) || 0;
        const particulars = document.getElementById('particulars').value;
        const partialPercentage = parseFloat(document.getElementById('partial_percentage').value) || 100;
        const incentiveAmount = parseFloat(document.getElementById('incentive_amount').value) || 0;

        let totalGrossCommission = 0, totalTax = 0, totalNetCommission = 0;

        const agentTaxRate = parseFloat(document.getElementById('withholding_tax_rate').value) || 10;
        const operationManagerTaxRate = parseFloat(document.getElementById('operation_manager_tax_rate').value) || 10;
        const coFounderTaxRate = parseFloat(document.getElementById('co_founder_tax_rate').value) || 10;
        const founderTaxRate = parseFloat(document.getElementById('founder_tax_rate').value) || 10;
        const fundsTaxRate = parseFloat(document.getElementById('funds_tax_rate').value) || 10;

        const cashAdvanceTax = cashAdvance * 0.10;
        const netCashAdvance = cashAdvance - cashAdvanceTax;
        const adjustedTotal = totalSellingPrice - netCashAdvance;

        const selectedPosition = document.getElementById('position_display').value || 'Sales Manager';

        const positionsContainer = document.getElementById('positions-container');
        positionsContainer.innerHTML = ''; // Clear previous hidden fields

        const positions = [
            { id: 'manager_commission_rate', name: selectedPosition, taxRate: agentTaxRate, is_primary: true },
            { id: 'om_rate', name: 'Operation Manager', taxRate: operationManagerTaxRate, is_primary: false },
            { id: 'cf_rate', name: 'Co-Founder', taxRate: coFounderTaxRate, is_primary: false },
            { id: 'founder_rate', name: 'Founder', taxRate: founderTaxRate, is_primary: false },
            { id: 'funds_rate', name: 'Funds', taxRate: fundsTaxRate, is_primary: false }
        ];

        const tableBody = document.getElementById('previewTableBody');
        tableBody.innerHTML = '';

        positions.forEach(pos => {
            const rateInput = document.getElementById(pos.id);
            const rate = parseFloat(rateInput ? rateInput.value : 0) || 0;

            if (rate > 0) {
                let baseCommission = adjustedTotal * (rate / 100);
                if (particulars === 'PARTIAL COMM') {
                    baseCommission *= (partialPercentage / 100);
                }

                let grossCommission = baseCommission;
                if (particulars === 'INCENTIVES' && pos.is_primary) {
                    grossCommission += incentiveAmount;
                }

                const tax = grossCommission * (pos.taxRate / 100);
                const netCommission = grossCommission - tax;

                totalGrossCommission += grossCommission;
                totalTax += tax;
                totalNetCommission += netCommission;

                const row = `
                    <tr>
                        <td class="px-4 py-2">${pos.name}</td>
                        <td class="px-4 py-2">${rate}%</td>
                        <td class="px-4 py-2">${particulars === 'PARTIAL COMM' ? partialPercentage : 100}%</td>
                        <td class="px-4 py-2">₱${formatCurrency(grossCommission)}</td>
                        <td class="px-4 py-2">₱${formatCurrency(tax)}</td>
                        <td class="px-4 py-2 font-semibold">₱${formatCurrency(netCommission)}</td>
                    </tr>`;
                tableBody.innerHTML += row;

                // Add hidden fields for form submission
                const positionInput = document.createElement('input');
                positionInput.type = 'hidden';
                positionInput.name = 'position';
                positionInput.value = pos.name;
                positionsContainer.appendChild(positionInput);

                const isPrimaryInput = document.createElement('input');
                isPrimaryInput.type = 'hidden';
                isPrimaryInput.name = 'is_primary';
                isPrimaryInput.value = pos.is_primary;
                positionsContainer.appendChild(isPrimaryInput);
            }
        });

        document.getElementById('totalGrossCommission').textContent = `₱${formatCurrency(totalGrossCommission)}`;
        document.getElementById('totalTax').textContent = `₱${formatCurrency(totalTax)}`;
        document.getElementById('totalNetCommission').textContent = `₱${formatCurrency(totalNetCommission)}`;
    }

    function updateAgentInfo() {
        const select = document.getElementById('agent_select');
        const selectedOption = select.options[select.selectedIndex];
        document.getElementById('agent_name_display').value = selectedOption.dataset.name || '';
        document.getElementById('position_display').value = selectedOption.dataset.position || '';
        updateCommissionPreview();
    }

    document.addEventListener('DOMContentLoaded', function() {
        updateFieldsVisibility();
        updateCommissionPreview();
        document.getElementById('date').value = new Date().toISOString().split('T')[0];

        // Add event listeners to all inputs that affect the calculation
        const inputs = [
            'total_selling_price',
            'cash_advance',
            'partial_percentage',
            'incentive_amount',
            'manager_commission_rate',
            'om_rate',
            'cf_rate',
            'founder_rate',
            'funds_rate',
            'withholding_tax_rate',
            'operation_manager_tax_rate',
            'co_founder_tax_rate',
            'founder_tax_rate',
            'funds_tax_rate'
        ];

        inputs.forEach(id => {
            const input = document.getElementById(id);
            if (input) {
                input.addEventListener('input', updateCommissionPreview);
            }
        });

        document.getElementById('particulars').addEventListener('change', updateFieldsVisibility);
        document.getElementById('agent_select').addEventListener('change', updateAgentInfo);
    });
</script>

{% endblock %}