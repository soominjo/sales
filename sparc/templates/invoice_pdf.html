{% load static %}
{% load humanize %}
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Invoice {{ invoice.invoice_no }}</title>
  <!-- CSS will be injected here by the view -->
</head>
<body class="p-6 bg-gray-50 font-sans text-gray-700">
  <div class="max-w-5xl mx-auto bg-white shadow-lg rounded-lg overflow-hidden border border-gray-300">
    <!-- Watermark -->
    <div class="absolute inset-0 flex items-center justify-center pointer-events-none">
      <div class="watermark font-bold text-gray-400">INVOICE</div>
    </div>
    
    <!-- Header Section -->
    <div class="header-bg p-8 border-b-2 border-primary">
      <div class="flex justify-between items-start">
        <div>
          <div class="flex items-center mb-4">
            <img src="{{ company_logo_path }}" alt="logo" class="h-16 mr-4">
            <div>
              <h1 class="text-3xl font-bold text-dark">INNER SPARC REALTY CORPORATION</h1>
              <p class="text-accent font-medium">Professional Real Estate Services</p>
            </div>
          </div>
          <div class="text-sm">
            <p>BLK 26 LOT 4 PH 3 AVIDA RESIDENCES STA CATALINA SALAWAG</p>
            <p class="ml-6">DASMARIÑAS CITY, CAVITE 4114</p>
            <p>TIN 625-453-930-00000</p>
          </div>
        </div>
        <div class="text-right">
          <div class="inline-block px-6 py-3 bg-primary text-white text-xl font-bold rounded-lg shadow-md">
            BILLING INVOICE
          </div>
          <div class="mt-4 p-3 bg-white border border-gray-300 rounded-lg inline-block">
            <p class="font-semibold text-gray-600">INVOICE #</p>
            <p class="text-2xl font-bold text-primary">{{ invoice.invoice_no }}</p>
          </div>
        </div>
      </div>
    </div>

    <!-- Client & Details Section -->
    <div class="p-8">
      <div class="grid grid-cols-2 gap-8 mb-8">
        <div class="border-l-4 border-primary pl-4">
          <h2 class="text-lg font-bold text-dark mb-3">BILL TO</h2>
          <p class="font-semibold">{{ invoice.client_name }}</p>
          <p class="text-sm">{{ invoice.client_address|linebreaksbr }}</p>
          <p class="mt-2"><span class="font-medium">VAT-REG TIN:</span> {{ invoice.client_tin }}</p>
          <p><span class="font-medium">Business Style:</span> {{ invoice.client_name }}</p>
        </div>
        
        <div class="grid grid-cols-2 gap-4">
          <div>
            <h3 class="font-bold text-dark mb-2">INVOICE DETAILS</h3>
            <div class="space-y-1">
              <p><span class="font-medium">Date Started:</span> {{ invoice.issue_date|date:'M d, Y' }}</p>
              <p><span class="font-medium">Due Date:</span> {{ invoice.due_date|date:'M d, Y' }}</p>
              <p><span class="font-medium">Terms:</span> {{ payment_terms }}</p>
            </div>
          </div>
          <div>
            <h3 class="font-bold text-dark mb-2">REFERENCE</h3>
            <p>{{ invoice.reference_no }}</p>
          </div>
        </div>
      </div>

      <!-- Items Table -->
      <div class="mb-8 overflow-hidden rounded-lg border border-gray-300 shadow-sm">
        <table class="w-full">
          <thead class="bg-gray-100">
            <tr class="text-left">
              <th class="py-3 px-4 font-semibold text-dark border-b">Item Code</th>
              <th class="py-3 px-4 font-semibold text-dark border-b">Description</th>
              <th class="py-3 px-4 font-semibold text-dark border-b text-center">Quantity</th>
              <th class="py-3 px-4 font-semibold text-dark border-b text-right">Net Commission</th>
              <th class="py-3 px-4 font-semibold text-dark border-b text-right">Less Tax</th>
              <th class="py-3 px-4 font-semibold text-dark border-b text-right">Expected Commission</th>
            </tr>
          </thead>
          <tbody>
            {% for item in stored_items %}
            <tr>
              <td class="py-3 px-4 border-b">{{ item.item_code }}</td>
              <td class="py-3 px-4 border-b">
                {{ item.description|linebreaksbr }}
                {% if is_combined_invoice %}
                  <div class="text-xs text-gray-500 mt-1">
                    Commission: 
                    {% for tranche in combined_tranches %}
                      #{{ tranche.tranche_number }}{% if not forloop.last %}, {% endif %}
                    {% endfor %}
                  </div>
                {% endif %}
              </td>
              <td class="py-3 px-4 border-b text-center">{{ item.quantity }}</td>
              <td class="py-3 px-4 border-b text-right">₱ {{ net_price|floatformat:2|intcomma }}</td>
              <td class="py-3 px-4 border-b text-right">₱ {{ vat_amount|floatformat:2|intcomma }}</td>
              <td class="py-3 px-4 border-b text-right font-medium text-primary">₱ {{ item.amount|floatformat:2|intcomma }}</td>
            </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>

      <!-- Summary & Billing Statement Section -->
      <div class="grid grid-cols-1 {% if billing_statement_items %}md:grid-cols-2{% endif %} gap-8 mb-8">
        {% if billing_statement_items %}
        <div class="border border-gray-300 rounded-lg overflow-hidden shadow-sm">
            <div class="bg-gray-100 p-3 border-b border-gray-300">
                <h3 class="font-bold text-dark">INVOICE HISTORY</h3>
            </div>
            <div class="p-4">
                <table class="w-full text-sm">
                    <thead>
                        <tr class="text-left">
                            <th class="py-2 px-3 font-semibold text-dark border-b">Date Received</th>
                            <th class="py-2 px-3 font-semibold text-dark border-b text-right">Amount</th>
                            <th class="py-2 px-3 font-semibold text-dark border-b text-center">Status</th>
                            <th class="py-2 px-3 font-semibold text-dark border-b text-center">Percentage</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for item in billing_statement_items %}
                        <tr>
                            <td class="py-2 px-3 border-b">
                                {% if item.date_received %}
                                    {{ item.date_received|date:"M d, Y" }}
                                {% else %}
                                    <span class="text-gray-500">--</span>
                                {% endif %}
                            </td>
                            <td class="py-2 px-3 border-b text-right">
                                ₱ {{ item.amount|floatformat:2|intcomma }}
                            </td>
                            <td class="py-2 px-3 border-b text-center">
                                <span class="inline-block px-2 py-1 text-xs font-semibold rounded
                                    {% if item.status == 'Received' %}text-green-700 bg-green-100
                                    {% elif item.status == 'Partial' %}text-yellow-700 bg-yellow-100
                                    {% else %}text-red-700 bg-red-100{% endif %}">
                                    {{ item.status }}
                                </span>
                            </td>
                            <td class="py-2 px-3 border-b text-center">
                                {{ item.percentage|floatformat:0 }}%
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
        {% endif %}

        <div class="w-full border border-gray-300 rounded-lg overflow-hidden shadow-sm {% if not billing_statement_items %}col-span-1 md:col-span-2{% endif %}">
          <div class="bg-gray-100 p-3 border-b border-gray-300">
            <h3 class="font-bold text-dark">SUMMARY</h3>
          </div>
          <div class="p-4 space-y-2">
            {% if is_combined_invoice and combined_commission_breakdown %}
              <!-- Combined Invoice Summary with Individual Breakdown -->
              {% for tranche, net_commission, tax_amount in combined_commission_breakdown %}
              <div class="flex justify-between">
                <span class="text-gray-600">Commission #{{ tranche.tranche_number }}:</span>
                <span class="font-medium text-gray-800">₱ {{ net_commission|floatformat:2|intcomma }}</span>
              </div>
              {% endfor %}
              <div class="flex justify-between pt-2 mt-2 border-t border-gray-300">
                <span class="font-semibold text-gray-700">Total Commission:</span>
                <span class="font-semibold text-gray-800">₱ {{ net_price|floatformat:2|intcomma }}</span>
              </div>
              <div class="flex justify-between">
                <span class="text-gray-600">Less Tax:</span>
                <span class="font-medium text-gray-800">₱ {{ vat_amount|floatformat:2|intcomma }}</span>
              </div>
              <div class="flex justify-between pt-3 mt-3 border-t-2 border-gray-200">
                <span class="font-bold text-gray-800">TOTAL AMOUNT DUE:</span>
                <span class="font-bold text-blue-600">₱ {{ total_due|floatformat:2|intcomma }}</span>
              </div>
            {% else %}
              <!-- Single Invoice Summary -->
              <div class="flex justify-between">
                <span class="text-gray-600">Commission:</span>
                <span class="font-medium text-gray-800">₱ {{ net_price|floatformat:2|intcomma }}</span>
              </div>
              <div class="flex justify-between">
                <span class="text-gray-600">Less: Tax ({{ invoice.vat_rate|floatformat:0 }}%)</span>
                <span class="font-medium text-gray-800">₱ {{ vat_amount|floatformat:2|intcomma }}</span>
              </div>
              <div class="flex justify-between pt-3 mt-3 border-t-2 border-gray-200">
                <span class="font-bold text-gray-800">TOTAL AMOUNT DUE:</span>
                <span class="font-bold text-blue-600">₱ {{ total_due|floatformat:2|intcomma }}</span>
              </div>
            {% endif %}
          </div>
        </div>
      </div>

      <!-- Authorization -->
      <div class="grid grid-cols-3 gap-6 mt-10 pt-6 border-t border-gray-300">
        <div class="text-center">
          <p class="font-semibold text-dark mb-1">Prepared By</p>
          <div class="mt-4 mb-2 border-b border-gray-400 w-4/5 mx-auto"></div>
          <p class="font-semibold text-primary">{{ invoice.prepared_by.get_full_name|default:'-' }}</p>
        </div>
        <div class="text-center">
          <p class="font-semibold text-dark mb-1">Approved By</p>
          <div class="mt-4 mb-2 border-b border-gray-400 w-4/5 mx-auto"></div>
          <p class="font-semibold text-primary">Inner SPARC Realty Corporation</p>
        </div>
        <div class="text-center">
          <p class="font-semibold text-dark mb-1">Checked By</p>
          <div class="mt-4 mb-2 border-b border-gray-400 w-4/5 mx-auto"></div>
          <p class="font-semibold text-primary">Inner SPARC Realty Corporation</p>
        </div>
      </div>
    </div>

    <!-- Footer -->
    <div class="bg-gray-100 p-4 text-center text-sm text-gray-600 border-t border-gray-300">
      <p>Thank you for your business! • Payment due by {{ invoice.due_date|date:'M d, Y' }}</p>
      <p class="mt-1">
        Contact: (046) 458-0706 • 
        innersparcrealtyservices@gmail.com • 
        https://www.innersparcrealty.com/
      </p>
    </div>
  </div>
</body>
</html>
