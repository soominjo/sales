{% extends "index.html" %}

{% load static %}


{% load humanize %}
{% load custom_filters %}


{% block content %}

<style>
    @media print {
        @page {
            size: auto;
            margin: 20px;
        }

        body {
            -webkit-print-color-adjust: exact;
            print-color-adjust: exact;
            padding: 20px;
        }

        .no-print {
            display: none !important;
        }

        .max-w-8xl {
            max-width: 100% !important; /* Ensure full width for printing */
            width: 100% !important;
        }

        table {
            width: 100% !important; /* Ensure tables expand fully */
            font-size: 12px !important;
        }

        .overflow-x-auto {
            overflow: visible !important; /* Ensure no horizontal scrolling in print */
        }

        .shadow, .rounded-lg {
            box-shadow: none !important;
            border-radius: 0 !important;
        }

        .bg-green-100, .bg-green-200, .bg-green-300,
        .bg-blue-100, .bg-blue-200, .bg-blue-300,
        .bg-yellow-200, .bg-red-200 {
            -webkit-print-color-adjust: exact;
            print-color-adjust: exact;
        }

        h3 {
            page-break-before: avoid;
            page-break-after: avoid;
        }

        .divide-y > :not([hidden]) ~ :not([hidden]) {
            border-bottom-width: 1px !important;
        }
    }

    @media print {
  .page-break {
    page-break-before: always;
  }

  @media print {
        .no-print {
            display: none !important;
        }
    }
}

    /* Update styles for more compact layout */
    .form-container {
        display: flex;
        position: relative;
        min-height: 400px;
        max-height: 800px;
        overflow-y: auto;
    }

    .left-sidebar {
        width: 25%;
        position: sticky;
        top: 0;
        height: fit-content;
        padding-right: 1rem;
        max-height: 800px;
    }

    .right-content {
        width: 75%;
        padding-left: 1rem;
        overflow-y: auto;
    }

    .section-button {
        width: 100%;
        text-align: left;
        margin-bottom: 0.5rem;
        transition: all 0.3s ease;
        padding: 0.75rem 1rem;
        background-color: #1E88E5; /* Solid blue */
        color: #FFFFFF; /* White text */
        border: none;
    }

    .section-button:hover {
        background-color: #1976D2; /* Slightly darker blue on hover */
    }

    .section-button.active {
        background-color: #1565C0; /* Darker blue for active state */
        color: #FFFFFF;
        box-shadow: inset 0 2px 4px rgba(0, 0, 0, 0.1);
    }

    .section-content {
        margin-bottom: 1rem;
        background-color: #FFFFFF;
        border: 2px solid #1E88E5;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
    }

    /* Update form background */
    form.bg-emerald-100 {
        background-color: #E3F2FD !important; /* Light blue background */
    }
</style>

<!-- UI Enhancements -->
<style>
/* Gradient sidebar with improved buttons */
.left-sidebar {
    background: linear-gradient(180deg,#1E88E5 0%,#42A5F5 100%);
    border-radius: 1rem;
    padding: 1rem;
}
.left-sidebar .section-button {
    background: transparent;
    color: #ffffff;
    font-weight: 600;
    border-left: 4px solid transparent;
    border-radius: 0;
}
.left-sidebar .section-button:hover {
    border-left-color: #ffffff;
    transform: translateX(3px);
}
.left-sidebar .section-button.active {
    background: rgba(255,255,255,0.15);
    border-left-color: #ffffff;
}

/* Fade-in for section content */
.section-content {
    animation: fadeIn 0.3s ease;
}
@keyframes fadeIn {
    from {opacity: 0; transform: translateY(10px);} 
    to   {opacity: 1; transform: translateY(0);} 
}

/* Mobile responsiveness: stack sidebar */
@media (max-width: 768px) {
    .left-sidebar {
        position: static;
        width: 100%;
        display: flex;
        overflow-x: auto;
        border-radius: 0;
    }
    .right-content {
        width: 100%;
        padding-left: 0;
    }
    .section-button {
        flex: 1 0 auto;
        text-align: center;
        font-size: 0.875rem;
        white-space: nowrap;
    }
}

/* Custom scrollbar */
::-webkit-scrollbar {
    width: 8px;
    height: 8px;
}
::-webkit-scrollbar-thumb {
    background: #cbd5e1;
    border-radius: 4px;
}
</style>
  

{% load widget_tweaks %}

    <div class="bg-white p-8 rounded-lg shadow-lg">
        <!-- Header Card -->
<div class="bg-white rounded-2xl shadow-lg overflow-hidden mb-8">
    <div class="bg-gradient-to-r from-blue-700 to-indigo-800 p-8">
        <div class="flex items-center justify-center space-x-8">
            <div class="bg-white p-3 rounded-2xl shadow-inner">
                <img src="{% static 'media/LOGO.png' %}" alt="Company Logo" class="w-20 h-20 object-contain">
            </div>
            <div class="text-white">
                <h2 class="text-3xl font-bold mb-2">Inner SPARC Realty Corporation</h2>
                <div class="text-sm opacity-90 space-y-1">
                    <p>Main Office: Block 26 Lot 4 Phase 3 Avida Residences Sta. Catalina</p>
                    <p>Salawag, Dasmari√±as, Cavite 4114</p>
                    <p>63917-853-4875 / 63999-994-3304 / (046)458-0706</p>
                </div>
            </div>
        </div>
    </div>
</div>
       
            

        <h1 class="text-3xl font-bold text-center text-gray-800 mb-8">
    <span class="bg-clip-text text-transparent bg-gradient-to-r from-blue-600 to-indigo-600">
        Commission Tranche Form
    </span>
</h1>

        <p class="text-sm text-gray-600 mb-4">Fill out the form below to generate the commission report, or upload an Excel file for bulk processing.</p>

       
        <form method="POST" class="bg-emerald-100 p-8 rounded-2xl shadow-lg">
            {% csrf_token %}
            
            <div class="form-container">
                <!-- Left Sidebar with Fixed Buttons -->
                <div class="left-sidebar">
                    <button type="button" onclick="toggleSection('projectDetails')" class="section-button font-bold py-3 px-4 rounded-xl shadow-sm">
                        Project Details
                    </button>
                    <button type="button" onclick="toggleSection('priceDetails')" class="section-button font-bold py-3 px-4 rounded-xl shadow-sm">
                        Price Details
                    </button>
                    <button type="button" onclick="toggleSection('otherDeductions')" class="section-button font-bold py-3 px-4 rounded-xl shadow-sm">
                        Other Deductions
                    </button>
                    <button type="button" onclick="toggleSection('commissionRelease')" class="section-button font-bold py-3 px-4 rounded-xl shadow-sm">
                        Condition For Commission Release
                    </button>
                    <button type="button" onclick="toggleSection('commissionSchedule')" class="section-button font-bold py-3 px-4 rounded-xl shadow-sm">
                        Commission Schedule
                    </button>
                </div>

                <!-- Right Content Area -->
                <div class="right-content">
                    <!-- Project Details Section -->
                    <div id="projectDetails" class="section-content w-full bg-white p-6 rounded-xl shadow-md hidden">
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                            <div>
                                <label for="agent_name" class="block text-gray-700 font-medium mb-2">Agent's Name</label>
                                {{ form.agent_name|add_class:"w-full p-3 border border-gray-300 rounded-lg focus:ring focus:ring-green-300" }}
                                {% if form.agent_name.errors %}
                                    <div class="text-red-500 text-sm mt-1">
                                        {{ form.agent_name.errors }}
                                    </div>
                                {% endif %}
                            </div>
                            <div>
                                <label for="buyer_name" class="block text-gray-700 font-medium mb-2">Client's Name</label>
                                {{ form.buyer_name|add_class:"w-full p-3 border border-gray-300 rounded-lg focus:ring focus:ring-green-300" }}
                            </div>
                            <div>
                                <label for="id_project_name" class="block uppercase tracking-wide text-gray-700 text-xs font-bold mb-2">
                                    Project Name
                                </label>
                                <select name="project_name" id="id_project_name" class="w-full p-3 border border-gray-300 rounded-lg focus:ring focus:ring-green-300 bg-white" required>
                                    <option value="" disabled selected>Select a property</option>
                                    {% for property in properties %}
                                        <option value="{{ property.name }}">{{ property.name }} - {{ property.developer.name }}</option>
                                    {% endfor %}
                                </select>
                            </div>
                            <div>
                                <label for="phase" class="block text-gray-700 font-medium mb-2">Phase</label>
                                {{ form.phase|add_class:"w-full p-3 border border-gray-300 rounded-lg focus:ring focus:ring-green-300" }}
                            </div>
                            <div>
                                <label for="unit_id" class="block text-gray-700 font-medium mb-2">Unit ID</label>
                                {{ form.unit_id|add_class:"w-full p-3 border border-gray-300 rounded-lg focus:ring focus:ring-green-300" }}
                            </div>
                            <div>
                                <label for="reservation_date" class="block text-gray-700 font-medium mb-2">Reservation Date</label>
                                {{ form.reservation_date|add_class:"w-full p-3 border border-gray-300 rounded-lg focus:ring focus:ring-green-300" }}
                            </div>
                        </div>
                    </div>

                    <!-- Price Details Section -->
                    <div id="priceDetails" class="section-content w-full bg-white p-6 rounded-xl shadow-md hidden">
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                            <div>
                                <label for="total_contract_price" class="block text-gray-700 font-medium mb-2">Total Contract Price</label>
                                {{ form.total_contract_price|add_class:"w-full p-3 border border-gray-300 rounded-lg focus:ring focus:ring-green-300 comma-format" }}
                            </div>
                            <div>
                                <label for="net_of_vat_amount" class="block text-gray-700 font-medium mb-2">Net of VAT (√∑)</label>
                                {{ form.net_of_vat_amount|add_class:"w-full p-3 border border-gray-300 rounded-lg focus:ring focus:ring-green-300 comma-format" }}
                            </div>
                            <div>
                                <label for="process_fee_percentage" class="block text-gray-700 font-medium mb-2">LMF/PF (%)</label>
                                {{ form.process_fee_percentage|add_class:"w-full p-3 border border-gray-300 rounded-lg focus:ring focus:ring-green-300" }}
                            </div>
                            <div>
                                <label for="commission_rate" class="block text-gray-700 font-medium mb-2">Commission Rate (%)</label>
                                {{ form.commission_rate|add_class:"w-full p-3 border border-gray-300 rounded-lg focus:ring focus:ring-green-300" }}
                            </div>
                            <div>
                                <label for="vat_rate" class="block text-gray-700 font-medium mb-2">VAT Rate (%)</label>
                                {{ form.vat_rate|add_class:"w-full p-3 border border-gray-300 rounded-lg focus:ring focus:ring-green-300" }}
                            </div>
                            <div>
                                <label for="withholding_tax_rate" class="block text-gray-700 font-medium mb-2">Withholding Tax Rate (%)</label>
                                {{ form.withholding_tax_rate|add_class:"w-full p-3 border border-gray-300 rounded-lg focus:ring focus:ring-green-300" }}
                            </div>
                        </div>
                    </div>

                    <!-- Other Deductions Section -->
                    <div id="otherDeductions" class="section-content w-full bg-white p-6 rounded-xl shadow-md hidden">
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                            <div>
                                <label for="deduction_type" class="block text-gray-700 font-medium mb-2">Deduction Type</label>
                                {{ form.deduction_type|add_class:"w-full p-3 border border-gray-300 rounded-lg focus:ring focus:ring-green-300" }}
                            </div>
                            <div>
                                <label for="other_deductions" class="block text-gray-700 font-medium mb-2">Other Deductions (‚Ç±)</label>
                                {{ form.other_deductions|add_class:"w-full p-3 border border-gray-300 rounded-lg focus:ring focus:ring-green-300" }}
                            </div>
                            <div>
                                <label for="deduction_tax_rate" class="block text-gray-700 font-medium mb-2">Tax Rate for Deduction (%)</label>
                                {{ form.deduction_tax_rate|add_class:"w-full p-3 border border-gray-300 rounded-lg focus:ring focus:ring-green-300" }}
                            </div>
                        </div>
                    </div>

                    <!-- Condition For Commission Release Section -->
                    <div id="commissionRelease" class="section-content w-full bg-white p-6 rounded-xl shadow-md hidden">
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                            <div>
                                <label for="option1_percentage" class="block text-gray-700 font-medium mb-2">Within Down Payment Period (%)</label>
                                {{ form.option1_percentage|add_class:"w-full p-3 border border-gray-300 rounded-lg focus:ring focus:ring-green-300" }}
                            </div>
                            <div>
                                <label for="option2_percentage" class="block text-gray-700 font-medium mb-2">Upon Loan Take Out (%)</label>
                                {{ form.option2_percentage|add_class:"w-full p-3 border border-gray-300 rounded-lg focus:ring focus:ring-green-300" }}
                            </div>
                            <div>
                                <label for="option1_tax_rate" class="block text-gray-700 font-medium mb-2">Tax Rate for DP Period (%)</label>
                                {{ form.option1_tax_rate|add_class:"w-full p-3 border border-gray-300 rounded-lg focus:ring focus:ring-green-300" }}
                            </div>
                            <div>
                                <label for="option2_tax_rate" class="block text-gray-700 font-medium mb-2">Tax Rate for Loan Take Out (%)</label>
                                {{ form.option2_tax_rate|add_class:"w-full p-3 border border-gray-300 rounded-lg focus:ring focus:ring-green-300" }}
                            </div>
                        </div>
                    </div>

                    <!-- Combine Date Details and Commission Received sections -->
                    <div id="commissionSchedule" class="section-content w-full bg-white p-6 rounded-xl shadow-md hidden">
                        <!-- Date Details -->
                        <div class="mb-8">
                            <h3 class="text-xl font-bold text-green-700 mb-4">Date Details</h3>
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                                <div>
                                    <label for="tranche_option" class="block text-gray-700 font-medium mb-2">Tranche Option</label>
                                    {{ form.tranche_option|add_class:"w-full p-3 border border-gray-300 rounded-lg focus:ring focus:ring-green-300" }}
                                </div>
                                <div>
                                    <label for="number_months" class="block text-gray-700 font-medium mb-2">No. of months</label>
                                    <input type="number" id="number_months" name="number_months" min="1" value="{{ form.number_months.value|default:'1' }}" 
                                           class="w-full p-3 border border-gray-300 rounded-lg focus:ring focus:ring-green-300"
                                           oninput="updateTrancheInputs()"
                                           onchange="updateTrancheInputs()">
                                </div>
                                <div>
                                    <label for="schedule2_gap_months" class="block text-gray-700 font-medium mb-2">Gap Between Schedules (in months):</label>
                                    <input type="number" name="schedule2_gap_months" value="1" min="1" class="w-full p-3 border border-gray-300 rounded-lg">
                                </div>
                            </div>
                        </div>

                  
                    </div>
                </div>
            </div>

            <!-- Submit Button -->
            <div class="text-center mt-6">
                <button type="submit" class="px-6 py-3 bg-blue-600 text-white font-bold rounded-lg hover:bg-blue-800 focus:ring focus:ring-green-300">
                    Generate Report
                </button>
            </div>
        </form>
    </div>

    <!-- Excel Results Display -->
    {% if excel_results %}
    <div class="bg-white p-8 rounded-lg shadow-lg mt-8">
        <div class="flex items-center justify-between mb-6">
            <h2 class="text-2xl font-bold text-gray-800 flex items-center">
                <svg class="w-8 h-8 mr-3 text-green-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                </svg>
                Excel Processing Results
            </h2>
            <div class="text-sm text-gray-600">
                <span class="font-semibold">{{ excel_results.filename }}</span> - 
                {{ excel_results.processed_rows }} of {{ excel_results.total_rows }} rows processed
            </div>
        </div>
        
        <div class="overflow-x-auto">
            <table class="min-w-full divide-y divide-gray-200">
                <thead class="bg-gray-50">
                    <tr>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Row</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Agent</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Client</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Project</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Unit ID</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Contract Price</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Commission Rate</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Gross Commission</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">DP Period Net</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">LTO Net</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Total Net</th>
                    </tr>
                </thead>
                <tbody class="bg-white divide-y divide-gray-200">
                    {% for result in excel_results.results %}
                    <tr class="{% if result.error %}bg-red-50{% else %}hover:bg-gray-50{% endif %}">
                        <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">{{ result.row_number }}</td>
                        {% if result.error %}
                            <td colspan="10" class="px-6 py-4 whitespace-nowrap text-sm text-red-600">
                                <div class="flex items-center">
                                    <svg class="w-5 h-5 mr-2 text-red-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                                    </svg>
                                    {{ result.error }}
                                </div>
                            </td>
                        {% else %}
                            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">{{ result.agent_name }}</td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">{{ result.buyer_name }}</td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">{{ result.project_name }}</td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">{{ result.unit_id }}</td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">‚Ç±{{ result.total_contract_price|floatformat:2 }}</td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">{{ result.commission_rate|floatformat:2 }}%</td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm font-semibold text-blue-600">‚Ç±{{ result.gross_commission|floatformat:2 }}</td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm font-semibold text-green-600">‚Ç±{{ result.dp_period_net|floatformat:2 }}</td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm font-semibold text-green-600">‚Ç±{{ result.lto_net|floatformat:2 }}</td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm font-bold text-green-700">‚Ç±{{ result.total_net_commission|floatformat:2 }}</td>
                        {% endif %}
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
        
        <!-- Summary Statistics -->
        <div class="mt-6 grid grid-cols-1 md:grid-cols-4 gap-4">
            <div class="bg-blue-50 p-4 rounded-lg">
                <p class="text-sm font-medium text-blue-600">Total Rows Processed</p>
                <p class="text-2xl font-bold text-blue-700">{{ excel_results.processed_rows }}</p>
            </div>
            <div class="bg-green-50 p-4 rounded-lg">
                <p class="text-sm font-medium text-green-600">Successful Calculations</p>
                <p class="text-2xl font-bold text-green-700">{{ excel_results.results|length }}</p>
            </div>
            <div class="bg-yellow-50 p-4 rounded-lg">
                <p class="text-sm font-medium text-yellow-600">Total Gross Commission</p>
                <p class="text-2xl font-bold text-yellow-700">‚Ç±{% widthratio excel_results.results|length 1 0 as total_gross %}{{ total_gross|floatformat:2 }}</p>
            </div>
            <div class="bg-purple-50 p-4 rounded-lg">
                <p class="text-sm font-medium text-purple-600">Total Net Commission</p>
                <p class="text-2xl font-bold text-purple-700">‚Ç±{% widthratio excel_results.results|length 1 0 as total_net %}{{ total_net|floatformat:2 }}</p>
            </div>
        </div>
    </div>
    {% endif %}

    <!-- Live Calculation Preview -->
    <div id="live-preview-container" class="bg-white p-6 rounded-lg shadow-md mt-8 border border-gray-200">
        <h2 class="text-xl font-semibold text-gray-700 mb-4 border-b pb-3">Live Calculation Preview</h2>
        <div class="overflow-x-auto">
            <table class="min-w-full text-sm">
                <tbody class="divide-y divide-gray-200">
                    <!-- Price Details -->
                    <tr class="hover:bg-gray-50">
                        <td class="p-3 font-medium text-gray-600">Total Contract Price</td>
                        <td id="preview-total-contract-price" class="p-3 text-right font-semibold text-gray-800">‚Ç±0.00</td>
                    </tr>
                    <tr class="hover:bg-gray-50">
                        <td class="p-3 font-medium text-gray-600">Net of VAT</td>
                        <td id="preview-base-amount" class="p-3 text-right font-semibold text-gray-800">‚Ç±0.00</td>
                    </tr>
                    <tr class="hover:bg-gray-50">
                        <td class="p-3 font-medium text-gray-600">LMF</td>
                        <td id="preview-lmf-amount" class="p-3 text-right font-semibold text-gray-800">‚Ç±0.00</td>
                    </tr>

                    <!-- Commission Calculation -->
                    <tr class="bg-blue-50 hover:bg-blue-100">
                        <td class="p-3 font-medium text-blue-700">Total Selling Price</td>
                        <td id="preview-commissionable-amount" class="p-3 text-right font-bold text-blue-800">‚Ç±0.00</td>
                    </tr>
                    <tr class="bg-blue-50 hover:bg-blue-100">
                        <td class="p-3 font-medium text-blue-700">Gross Commission</td>
                        <td id="preview-total-commission" class="p-3 text-right font-bold text-blue-800">‚Ç±0.00</td>
                    </tr>

                    <tr class="hover:bg-gray-50">
                        <td class="p-3 font-medium text-gray-600">VAT Amount</td>
                        <td id="preview-commission-vat" class="p-3 text-right font-semibold text-gray-800">‚Ç±0.00</td>
                    </tr>


                    <!-- Taxes and Deductions -->
                    <tr class="hover:bg-gray-50">
                        <td class="p-3 font-medium text-gray-600">Commission (Net of VAT)</td>
                        <td id="preview-commission-net-vat" class="p-3 text-right font-semibold text-gray-800">‚Ç±0.00</td>
                    </tr>
                   

                    <tr class="bg-red-50 hover:bg-red-100">
                        <td class="p-3 font-medium text-red-700">Withholding Tax</td>
                        <td id="preview-withholding-tax" class="p-3 text-right font-bold text-red-800">‚Ç±0.00</td>
                    </tr>
                

                    <!-- Net Commission -->
                    <tr class="bg-green-100 hover:bg-green-200">
                        <td class="p-3 text-lg font-bold text-green-800">Net Commission Payable</td>
                        <td id="preview-net-commission" class="p-3 text-right text-2xl font-extrabold text-green-800">‚Ç±0.00</td>
                    </tr>
                </tbody>
            </table>
        </div>
    </div>

   

    <script>
        document.getElementById('toggleFormButton').addEventListener('click', function() {
            const formContainer = document.getElementById('formContainer');
            formContainer.classList.toggle('hidden');
            this.textContent = formContainer.classList.contains('hidden') ? 'Show Data' : 'Hide Data';
        });
    </script>

    <script>
        document.addEventListener("DOMContentLoaded", function () {
            const form = document.querySelector("form");
            const option1Input = document.querySelector("input[name='option1_percentage']");
            const option2Input = document.querySelector("input[name='option2_percentage']");
    
            form.addEventListener("submit", function (e) {
                const option1Value = parseFloat(option1Input.value) || 0;
                const option2Value = parseFloat(option2Input.value) || 0;
    
                if (option1Value + option2Value > 100) {
                    e.preventDefault(); // Prevent form submission
                    alert("The total percentage cannot exceed 100%. Please adjust the percentage.");
                }
            });
        });
    </script>

<script>
    const trancheCount = "{{ tranches|length|default:0 }}";
    const trancheOption = "{{ tranche_option|default:'' }}";
    const reservationDate = "{{ reservation_date|date:'Y-m-d'|default:'' }}";

    // Define intervals based on the tranche option
    const trancheIntervals = {
        "bi_monthly": [30, 60, 90, 120, 150],
        "quarterly": [90, 180, 270, 360],
        "semi_annual": [180, 360],
        "nine_months": [270],
        "default": [30, 60, 90, 120, 150]
    };

    document.getElementById('addTrancheRow').addEventListener('click', function () {
        trancheCount += 1;
        const container = document.getElementById('commissionReceivedContainer');

        const newRow = document.createElement('div');
        newRow.classList.add('commission-row');

        newRow.innerHTML = `
            <label for="commission_received_${trancheCount}" class="block text-gray-700 font-medium">
                Tranche ${trancheCount} (0%):
            </label>
            <input type="number" step="0.01" name="commission_received_${trancheCount}" 
                   id="commission_received_${trancheCount}" 
                   class="w-full mt-1 p-3 border border-gray-300 rounded-lg focus:ring focus:ring-green-300"
                   value="0.00">
        `;

        container.appendChild(newRow);
    });

    document.addEventListener("DOMContentLoaded", function () {
  const inputs = document.querySelectorAll('.comma-format');

  inputs.forEach(input => {
    input.addEventListener('input', function (e) {
      // Remove non-numeric characters except dot
      let value = e.target.value.replace(/,/g, '').replace(/[^\d.]/g, '');
      
      // Split into integer and decimal parts
      const parts = value.split('.');
      parts[0] = parts[0].replace(/\B(?=(\d{3})+(?!\d))/g, ',');

      e.target.value = parts.join('.');
    });
  });
});
</script>

<script>
    // Simple function to handle section toggling
    function toggleSection(sectionId) {
        // Hide all sections
        document.querySelectorAll('.section-content').forEach(section => {
            section.classList.add('hidden');
        });

        // Show the selected section
        const selectedSection = document.getElementById(sectionId);
        if (selectedSection) {
            selectedSection.classList.remove('hidden');
        }

        // Update button styles
        document.querySelectorAll('.section-button').forEach(button => {
            if (button.getAttribute('onclick').includes(sectionId)) {
                button.classList.add('active');
            } else {
                button.classList.remove('active');
            }
        });
    }

    // Add click handlers to all buttons when the page loads
    document.addEventListener('DOMContentLoaded', function() {
        // Add click event to each button
        document.querySelectorAll('.section-button').forEach(button => {
            button.addEventListener('click', function() {
                const sectionId = this.getAttribute('onclick').split("'")[1];
                toggleSection(sectionId);
            });
        });

        // Show the first section by default
        toggleSection('projectDetails');
    });
</script>

<script>
    // Function to get current date in YYYY-MM-DD format
    function getCurrentDate() {
        const today = new Date();
        const year = today.getFullYear();
        const month = String(today.getMonth() + 1).padStart(2, '0');
        const day = String(today.getDate()).padStart(2, '0');
        return `${year}-${month}-${day}`;
    }

    // Function to update tranche inputs based on number of months
    function updateTrancheInputs() {
        const months = parseInt(document.getElementById('number_months').value) || 1;
        const container1 = document.getElementById('commissionReceivedContainer');
        const container2 = document.getElementById('commissionReceivedContainer2');
        
        // Clear existing inputs
        container1.innerHTML = '';
        container2.innerHTML = '';

        // Create inputs for Tranche 1 (DP Period) - Dynamic based on months
        for (let i = 1; i <= months; i++) {
            const inputDiv = document.createElement('div');
            inputDiv.className = 'commission-row group relative mb-4';
            inputDiv.innerHTML = `
                <label for="commission_received_${i}" 
                       class="block text-green-700 font-medium mb-2 pl-1 border-l-4 border-green-300 bg-yellow-200 py-1 px-3 rounded-r">
                    Tranche ${i} ({{ option1_percentage|floatformat:2 }}%)
                </label>
                <div>
                <input type="number" step="0.01" name="commission_received_${i}" 
                       id="commission_received_${i}" 
                       class="w-full mt-1 p-3 border-2 border-green-100 rounded-lg 
                              focus:border-green-400 focus:ring-2 focus:ring-green-200
                              hover:border-green-300 transition-colors duration-200
                              bg-white shadow-sm"
                           value="0.00"
                           placeholder="Enter amount received"
                           oninput="handleAmountInput(${i}, false)">
                    <input type="hidden" name="date_received_${i}" id="date_received_${i}">
                </div>
                <div class="absolute inset-0 border-2 border-transparent group-hover:border-green-100 rounded-lg pointer-events-none transition-all duration-300"></div>
            `;
            container1.appendChild(inputDiv);
        }

        // Create single input for Tranche 2 (LTO)
        const ltoDiv = document.createElement('div');
        ltoDiv.className = 'commission-row group relative mb-4';
        ltoDiv.innerHTML = `
            <label for="commission_received2_1" 
                       class="block text-blue-700 font-medium mb-2 pl-1 border-l-4 border-blue-300 bg-blue-200 py-1 px-3 rounded-r">
                LTO Tranche ({{ option2_percentage|floatformat:2 }}%)
                </label>
            <div>
                <input type="number" step="0.01" name="commission_received2_1" 
                       id="commission_received2_1" 
                       class="w-full mt-1 p-3 border-2 border-blue-100 rounded-lg 
                              focus:border-blue-400 focus:ring-2 focus:ring-blue-200
                              hover:border-blue-300 transition-colors duration-200
                              bg-white shadow-sm"
                       value="0.00"
                       placeholder="Enter LTO amount received"
                       oninput="handleAmountInput(1, true)">
                <input type="hidden" name="date_received2_1" id="date_received2_1">
            </div>
                <div class="absolute inset-0 border-2 border-transparent group-hover:border-blue-100 rounded-lg pointer-events-none transition-all duration-300"></div>
            `;
        container2.appendChild(ltoDiv);
    }

    // Function to handle amount input and set current date
    function handleAmountInput(trancheNum, isLTO) {
        const amountInput = document.getElementById(`commission_received${isLTO ? '2_' : '_'}${trancheNum}`);
        const dateInput = document.getElementById(`date_received${isLTO ? '2_' : '_'}${trancheNum}`);
        
        const amount = parseFloat(amountInput.value) || 0;
        if (amount > 0) {
            dateInput.value = getCurrentDate();
        } else {
            dateInput.value = '';
        }
    }

    // --- Live Calculation Logic ---
    document.addEventListener('DOMContentLoaded', function() {
        const fieldIds = [
            'id_total_contract_price',
            'id_net_of_vat_amount',
            'id_process_fee_percentage',
            'id_commission_rate',
            'id_vat_rate',
            'id_withholding_tax_rate',
            'id_other_deductions'
        ];

        // Fields that should not trigger net_of_vat_amount recalculation
        const fieldsExcludingNetVat = [
            'id_total_contract_price',
            'id_process_fee_percentage',
            'id_commission_rate',
            'id_withholding_tax_rate',
            'id_other_deductions'
        ];

        const getFloatValue = (id) => {
            const element = document.getElementById(id);
            return element ? (parseFloat(element.value.replace(/,/g, '')) || 0) : 0;
        };

        const updateLivePreview = () => {
            const totalContractPrice = getFloatValue('id_total_contract_price');
            const netOfVatDivisor = getFloatValue('id_net_of_vat_amount');
            const processFeePercentage = getFloatValue('id_process_fee_percentage') / 100;
            const commissionRate = getFloatValue('id_commission_rate') / 100;
            const vatRate = getFloatValue('id_vat_rate') / 100;
            const withholdingTaxRate = getFloatValue('id_withholding_tax_rate') / 100;
            // --- Calculations ---
            const baseAmount = netOfVatDivisor > 0 ? totalContractPrice / netOfVatDivisor : 0;
            const lmfAmount = baseAmount * processFeePercentage;
            const commissionableAmount = baseAmount - lmfAmount;
            const grossCommission = commissionableAmount * commissionRate;
            const commissionNetVat = grossCommission / (1 + vatRate);
            const commissionVatAmount = grossCommission - commissionNetVat;
            const withholdingTax = commissionNetVat * withholdingTaxRate;
            const netCommissionPayable = grossCommission - withholdingTax;

            // --- UI Update ---
            const formatCurrency = (amount) => new Intl.NumberFormat('en-PH', { style: 'currency', currency: 'PHP' }).format(amount);

            document.getElementById('preview-total-contract-price').textContent = formatCurrency(totalContractPrice);
            document.getElementById('preview-base-amount').textContent = formatCurrency(baseAmount);
            document.getElementById('preview-lmf-amount').textContent = formatCurrency(lmfAmount);
            document.getElementById('preview-commissionable-amount').textContent = formatCurrency(commissionableAmount);
            document.getElementById('preview-total-commission').textContent = formatCurrency(grossCommission);
            document.getElementById('preview-commission-net-vat').textContent = formatCurrency(commissionNetVat);
            document.getElementById('preview-commission-vat').textContent = formatCurrency(commissionVatAmount);
            document.getElementById('preview-withholding-tax').textContent = formatCurrency(withholdingTax);
            document.getElementById('preview-net-commission').textContent = formatCurrency(netCommissionPayable);
        };

        // Debounce function to delay execution
        let debounceTimeout;
        const debouncedUpdate = () => {
            clearTimeout(debounceTimeout);
            debounceTimeout = setTimeout(updateLivePreview, 250);
        };

        // Attach listeners for fields excluding VAT rate affecting net of VAT
        fieldsExcludingNetVat.forEach(id => {
            const input = document.getElementById(id);
            if (input) {
                input.addEventListener('keyup', debouncedUpdate);
                input.addEventListener('change', debouncedUpdate);
            }
        });

        // Separate listener for net_of_vat_amount - only updates when manually changed
        const netOfVatInput = document.getElementById('id_net_of_vat_amount');
        if (netOfVatInput) {
            netOfVatInput.addEventListener('keyup', debouncedUpdate);
            netOfVatInput.addEventListener('change', debouncedUpdate);
        }

        // Separate listener for VAT rate - updates calculations but not net_of_vat_amount
        const vatRateInput = document.getElementById('id_vat_rate');
        if (vatRateInput) {
            vatRateInput.addEventListener('keyup', debouncedUpdate);
            vatRateInput.addEventListener('change', debouncedUpdate);
        }

        // Initial calculation on page load
        updateLivePreview();
    });

    // Excel Upload JavaScript
    document.addEventListener('DOMContentLoaded', function() {
        const excelForm = document.getElementById('excel-upload-form');
        const fileInput = document.getElementById('excel-file-input');
        const downloadTemplate = document.getElementById('download-template');
        
        // Auto-submit on file selection
        if (fileInput) {
            fileInput.addEventListener('change', function() {
                if (this.files.length > 0) {
                    // Show loading state
                    const submitBtn = excelForm.querySelector('button[type="submit"]');
                    const originalText = submitBtn.innerHTML;
                    submitBtn.innerHTML = '<svg class="animate-spin -ml-1 mr-3 h-5 w-5 text-white" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg>Processing...';
                    submitBtn.disabled = true;
                    
                    // Submit form
                    setTimeout(() => {
                        excelForm.submit();
                    }, 500);
                }
            });
        }
        
        // Download template functionality
        if (downloadTemplate) {
            downloadTemplate.addEventListener('click', function() {
                // Create a sample Excel template
                const csvContent = 'agent_name,buyer_name,project_name,unit_id,total_contract_price,commission_rate,vat_rate,withholding_tax_rate,process_fee_percentage,option1_percentage,option2_percentage,other_deductions\n' +
                    'John Doe,Jane Smith,Sample Project,A-101,1500000,7,12,10,0,50,50,0\n' +
                    'Mary Johnson,Bob Wilson,Another Project,B-202,2000000,8,12,10,0,60,40,5000';
                
                const blob = new Blob([csvContent], { type: 'text/csv' });
                const url = window.URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = 'tranche_template.csv';
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                window.URL.revokeObjectURL(url);
            });
        }
        
        // File drag and drop functionality
        if (fileInput) {
            const dropZone = fileInput;
            
            ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
                dropZone.addEventListener(eventName, preventDefaults, false);
            });
            
            function preventDefaults(e) {
                e.preventDefault();
                e.stopPropagation();
            }
            
            ['dragenter', 'dragover'].forEach(eventName => {
                dropZone.addEventListener(eventName, highlight, false);
            });
            
            ['dragleave', 'drop'].forEach(eventName => {
                dropZone.addEventListener(eventName, unhighlight, false);
            });
            
            function highlight(e) {
                dropZone.classList.add('border-blue-500', 'bg-blue-50');
            }
            
            function unhighlight(e) {
                dropZone.classList.remove('border-blue-500', 'bg-blue-50');
            }
            
            dropZone.addEventListener('drop', handleDrop, false);
            
            function handleDrop(e) {
                const dt = e.dataTransfer;
                const files = dt.files;
                
                if (files.length > 0) {
                    fileInput.files = files;
                    fileInput.dispatchEvent(new Event('change'));
                }
            }
        }
    });
</script>

{% endblock %}