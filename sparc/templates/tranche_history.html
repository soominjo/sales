{% extends "index.html" %}
{% block title %}Tranche History{% endblock %}
{% load static humanize %}

{% block content %}

<style>
  /* Modern color scheme */
  :root {
    --primary: #4361ee;
    --primary-light: #eef2ff;
    --secondary: #3f37c9;
    --success: #06d6a0;
    --warning: #ffd166;
    --danger: #ef476f;
    --dark: #1e293b;
    --light: #f8fafc;
    --gray: #94a3b8;
    --border: #e2e8f0;
  }
  
  /* Animations */
  @keyframes fadeIn {
    from { opacity: 0; transform: translateY(10px); }
    to { opacity: 1; transform: translateY(0); }
  }
  
  @keyframes slideIn {
    from { transform: translateY(-20px); opacity: 0; }
    to { transform: translateY(0); opacity: 1; }
  }
  
  .animate-fade-in {
    animation: fadeIn 0.5s ease-out forwards;
  }
  
  .animate-slide-in {
    animation: slideIn 0.6s ease-out forwards;
  }
  
  /* Card styles */
  .tranche-card {
    transition: all 0.3s ease;
    box-shadow: 0 4px 6px rgba(0, 0, 0, 0.05);
    border: 1px solid var(--border);
  }
  
  .tranche-card:hover {
    transform: translateY(-5px);
    box-shadow: 0 10px 15px rgba(0, 0, 0, 0.1);
  }
  
  /* Status badges */
  .status-badge {
    transition: all 0.3s ease;
  }
  
  /* Progress bars */
  .progress-bar {
    transition: width 0.8s ease-out;
  }
  
  /* Mobile optimizations */
  @media (max-width: 768px) {
    .tranche-card:hover {
      transform: none;
    }
    
    .grid-cols-1 {
      grid-template-columns: 1fr;
    }
  }
</style>

<div class="min-h-screen bg-gray-50 p-4 md:p-8">
  <div class="max-w-7xl mx-auto">
    <!-- Header -->
    <div class="mb-8 flex flex-col md:flex-row justify-between items-start md:items-center gap-4">
      <div>
        <h1 class="text-2xl md:text-3xl font-bold text-gray-800 flex items-center">
          <i class="fas fa-history text-blue-500 mr-3"></i>
          Tranche Dashboard
        </h1>
        <p class="text-gray-600 mt-2">Track and manage all payment tranches</p>
      </div>
      
      {% if user.is_superuser or user.is_staff %}
      <a href="{% url 'tranches' %}" 
         class="inline-flex items-center px-5 py-3 bg-blue-600 hover:bg-blue-700 text-white rounded-lg shadow-md transition-all duration-300">
        <i class="fas fa-plus-circle mr-2"></i> 
        Create Tranche
      </a>
      {% endif %}
    </div>
    
    <!-- Stats Cards -->
    <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8">
      <div class="bg-gradient-to-r from-green-50 to-green-100 p-6 rounded-2xl border-l-4 border-green-500">
        <div class="flex justify-between items-center">
          <div>
            <h3 class="text-lg font-medium text-green-800">Total Value</h3>
            <p class="text-3xl font-bold text-gray-800 mt-2">â‚±{{ total_contract_value|floatformat:2|intcomma }}</p>
          </div>
          <div class="bg-green-100 p-3 rounded-full">
            <i class="fas fa-money-bill-wave text-green-600 text-xl"></i>
          </div>
        </div>
      </div>
      
   
      
      <div class="bg-gradient-to-r from-blue-50 to-blue-100 p-6 rounded-2xl border-l-4 border-blue-500">
        <div class="flex justify-between items-center">
          <div>
            <h3 class="text-lg font-medium text-blue-800">Active Units</h3>
            <p class="text-3xl font-bold text-gray-800 mt-2">{{ active_tranches }}</p>
          </div>
          <div class="bg-blue-100 p-3 rounded-full">
            <i class="fas fa-sync-alt text-blue-600 text-xl"></i>
          </div>
        </div>
      </div>


      <div class="bg-gradient-to-r from-orange-50 to-orange-100 p-6 rounded-2xl border-l-4 border-orange-500">
        <div class="flex justify-between items-center">
          <div>
            <h3 class="text-lg font-medium text-orange-800">Total Units</h3>
            <p class="text-3xl font-bold text-gray-800 mt-2">{{ total_records }}</p>
          </div>
          <div class="bg-orange-100 p-3 rounded-full">
            <i class="fas fa-list-alt text-orange-600 text-xl"></i>
          </div>
        </div>
      </div>
    </div>

    
    
    <!-- Filters -->
    <div class="bg-white rounded-xl shadow p-6 mb-8">
      <h3 class="text-lg font-semibold text-gray-800 mb-4">Filters</h3>
      <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-6 gap-4 mb-6">
        <!-- Year Filter -->
        <div>
          <label for="yearFilter" class="block text-sm font-medium text-gray-700 mb-2">Year</label>
          <select id="yearFilter" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 shadow-sm">
            <option value="">All Years</option>
            {% for year in available_years %}
              <option value="{{ year }}" {% if year|stringformat:"s" == selected_year %}selected{% endif %}>{{ year }}</option>
            {% endfor %}
          </select>
        </div>

        <!-- Month Filter -->
        <div>
          <label for="monthFilter" class="block text-sm font-medium text-gray-700 mb-2">Month</label>
          <select id="monthFilter" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 shadow-sm">
            <option value="">All Months</option>
            {% for month_num, month_name in available_months %}
              <option value="{{ month_num }}" {% if month_num|stringformat:"s" == selected_month %}selected{% endif %}>{{ month_name }}</option>
            {% endfor %}
          </select>
        </div>

        <!-- Developer Filter -->
        <div>
          <label for="developerFilter" class="block text-sm font-medium text-gray-700 mb-2">Developer</label>
          <select id="developerFilter" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 shadow-sm">
            <option value="">All Developers</option>
            {% for developer in all_developers %}
              <option value="{{ developer }}" {% if developer == selected_developer %}selected{% endif %}>{{ developer }}</option>
            {% endfor %}
          </select>
        </div>

        <!-- Property Filter -->
        <div>
          <label for="propertyFilter" class="block text-sm font-medium text-gray-700 mb-2">Property</label>
          <select id="propertyFilter" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 shadow-sm">
            <option value="">All Properties</option>
            {% for property in all_properties %}
              <option value="{{ property }}" {% if property == selected_property %}selected{% endif %}>{{ property }}</option>
            {% endfor %}
          </select>
        </div>

        <!-- Team Filter (Only for superusers) -->
        {% if user.is_superuser %}
        <div>
          <label for="teamFilter" class="block text-sm font-medium text-gray-700 mb-2">Team</label>
          <select id="teamFilter" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 shadow-sm">
            <option value="">All Teams</option>
            {% for team in all_teams %}
              <option value="{{ team.name }}" {% if team.name == selected_team %}selected{% endif %}>{{ team.display_name|default:team.name }}</option>
            {% endfor %}
          </select>
        </div>
        {% endif %}

        <!-- User Filter (Only for superusers) -->
        {% if user.is_superuser %}
        <div>
          <label for="userFilter" class="block text-sm font-medium text-gray-700 mb-2">User</label>
          <select id="userFilter" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 shadow-sm">
            <option value="">All Users</option>
            {% for agent in all_users %}
              <option value="{{ agent.id }}" {% if agent.id|stringformat:"s" == selected_user %}selected{% endif %}>{{ agent.get_full_name }}</option>
            {% endfor %}
          </select>
        </div>
        {% endif %}
      </div>

      <!-- Search -->
      <div class="flex flex-col md:flex-row gap-4 items-center">
        <div class="relative w-full">
          <input type="text" id="searchInput" placeholder="Search by project, agent, or buyer..." 
                 class="w-full pl-10 pr-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 shadow-sm">
          <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none text-gray-400">
            <i class="fas fa-search"></i>
          </div>
        </div>
        <div class="flex gap-3 w-full md:w-auto">
          <select id="statusFilter" class="w-full md:w-auto px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 shadow-sm">
            <option value="">All Status</option>
            <option value="active_pending">Active / Pending</option>
            <option value="completed">Completed</option>
          </select>
          <select id="dateFilter" class="w-full md:w-auto px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 shadow-sm">
            <option value="">All Time</option>
            <option value="today">Today</option>
            <option value="week">This Week</option>
            <option value="month">This Month</option>
            <option value="year">This Year</option>
          </select>
        </div>
      </div>
    </div>
    
    <!-- Tranche Cards -->
    <div class="mb-12">
      <div class="flex justify-between items-center mb-6">
        <h2 class="text-xl md:text-2xl font-bold text-gray-800 flex items-center">
          <i class="fas fa-file-invoice-dollar text-blue-500 mr-3"></i>
          All Tranche Records
        </h2>
        <span class="text-sm text-gray-500">
          {{ page_obj.paginator.count }} record{{ page_obj.paginator.count|pluralize }}
        </span>
      </div>
      
      {% if page_obj %}
      <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
        {% for stats in page_obj %}
        <div class="tranche-card bg-white rounded-2xl overflow-hidden animate-fade-in" 
             data-project="{{ stats.record.project_name|lower }}" 
             data-agent="{{ stats.record.agent_name|lower }}"
             data-buyer="{{ stats.record.buyer_name|lower }}"
             data-status="{{ stats.status|lower }}"
             data-date="{{ stats.record.reservation_date|date:'Y-m-d' }}">
          <div class="p-6">
            <!-- Project Header -->
            <div class="flex justify-between items-start mb-4">
              <div>
                <h3 class="font-bold text-gray-800 text-lg">{{ stats.record.project_name }}</h3>
                <p class="text-sm text-gray-600">Phase {{ stats.record.phase }}</p>
              </div>
              <div class="text-sm text-gray-500">
                {{ stats.record.reservation_date|date:"M d, Y" }}
              </div>
            </div>
            
            <!-- Agent & Buyer -->
            <div class="flex items-center mb-4">
              <div class="h-10 w-10 rounded-full bg-blue-500 flex items-center justify-center text-white font-bold">
                {{ stats.record.agent_name|first }}
              </div>
              <div class="ml-3">
                <p class="font-medium text-gray-800">{{ stats.record.agent_name }}</p>
                <p class="text-xs text-gray-600">Unit {{ stats.record.unit_id }}</p>
              </div>
            </div>
            
            <div class="mb-4">
              <p class="text-sm text-gray-700 mb-1">Buyer</p>
              <p class="font-medium text-gray-800">{{ stats.record.buyer_name }}</p>
            </div>
            
            <!-- Contract Price -->
            <div class="mb-4">
              <p class="text-sm text-gray-700 mb-1">Contract Price</p>
              <p class="text-xl font-bold text-gray-800">â‚± {{ stats.record.total_contract_price|floatformat:2|intcomma }}</p>
            </div>
            
            <!-- Progress -->
            <div class="mb-6">
              <div class="flex justify-between items-center mb-1">
                <span class="text-sm font-medium text-gray-700">Progress</span>
                <span class="text-xs font-semibold 
                  {% if stats.status == 'Completed' %}text-green-600
                  {% elif stats.status == 'In Progress' %}text-yellow-600
                  {% else %}text-red-600{% endif %}">
                  {{ stats.received_payments }}/{{ stats.total_payments }}
                </span>
              </div>
              <div class="w-full bg-gray-200 rounded-full h-2 overflow-hidden">
                <div class="progress-bar h-full rounded-full
                  {% if stats.status == 'Completed' %}bg-green-500
                  {% elif stats.status == 'In Progress' %}bg-yellow-500
                  {% else %}bg-red-500{% endif %}" 
                  style="width: {{ stats.completion_percentage }}%">
                </div>
              </div>
              <div class="flex justify-between mt-1">
                <span class="text-xs text-gray-500">Started</span>
                <span class="text-xs font-semibold 
                  {% if stats.status == 'Completed' %}text-green-600
                  {% elif stats.status == 'In Progress' %}text-yellow-600
                  {% else %}text-red-600{% endif %}">
                  {{ stats.status }}
                </span>
              </div>
            </div>
            
            <!-- Actions -->
            <div class="flex flex-wrap gap-2">
              <a href="{% url 'view_tranche' stats.record.id %}" 
                 class="flex-1 text-center px-4 py-2 bg-blue-100 hover:bg-blue-200 text-blue-700 rounded-lg transition">
                <i class="fas fa-eye mr-1"></i> <br>Details
              </a>
     
              {% if user.is_superuser or user.is_staff %}
              <a href="{% url 'edit_tranche' stats.record.id %}" 
                 class="flex-1 text-center px-4 py-2 bg-green-100 hover:bg-green-200 text-green-700 rounded-lg transition">
                <i class="fas fa-edit mr-1"></i> <br>Edit
              </a>
              
              <form method="POST" action="{% url 'delete_tranche' stats.record.id %}" class="flex-1">
                {% csrf_token %}
                <button type="submit" 
                        onclick="return confirm('Are you sure you want to delete this tranche record?')" 
                        class="w-full px-4 py-2 bg-red-100 hover:bg-red-200 text-red-700 rounded-lg transition">
                  <i class="fas fa-trash-alt mr-1"></i> Delete
                </button>
              </form>
              {% endif %}
            </div>
          </div>
        </div>
        {% endfor %}
      </div>
      
      <!-- Pagination -->
      {% if page_obj.paginator.num_pages > 1 %}
      <div class="mt-8 flex justify-center">
        <div class="flex items-center space-x-2">
          {% if page_obj.has_previous %}
          <a href="?page={{ page_obj.previous_page_number }}" 
             class="px-4 py-2 bg-white border border-gray-300 rounded-lg font-medium text-gray-700 hover:bg-gray-100 transition">
            <i class="fas fa-chevron-left mr-1"></i> Previous
          </a>
          {% endif %}
          
          <span class="px-4 py-2 bg-blue-100 text-blue-800 font-medium rounded-lg">
            Page {{ page_obj.number }} of {{ page_obj.paginator.num_pages }}
          </span>
          
          {% if page_obj.has_next %}
          <a href="?page={{ page_obj.next_page_number }}"
             class="px-4 py-2 bg-white border border-gray-300 rounded-lg font-medium text-gray-700 hover:bg-gray-100 transition">
            Next <i class="fas fa-chevron-right ml-1"></i>
          </a>
          {% endif %}
        </div>
      </div>
      {% endif %}
      {% else %}
      <div class="bg-white rounded-2xl p-8 text-center border border-gray-200 shadow-sm">
        <div class="mx-auto w-16 h-16 bg-blue-100 rounded-full flex items-center justify-center mb-4">
          <i class="fas fa-file-alt text-blue-500 text-2xl"></i>
        </div>
        <h3 class="text-lg font-medium text-gray-800 mb-2">No tranche records found</h3>
        <p class="text-gray-600">Create your first tranche record to get started</p>
      </div>
      {% endif %}
    </div>
  </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', () => {
  // Initialize search and filter functionality
  const searchInput = document.getElementById('searchInput');
  const statusFilter = document.getElementById('statusFilter');
  const dateFilter = document.getElementById('dateFilter');
  const yearFilter = document.getElementById('yearFilter');
  const monthFilter = document.getElementById('monthFilter');
  const developerFilter = document.getElementById('developerFilter');
  const propertyFilter = document.getElementById('propertyFilter');
  const userFilter = document.getElementById('userFilter');
  const teamFilter = document.getElementById('teamFilter');
  const trancheCards = document.querySelectorAll('.tranche-card');
  
  // Function to update URL parameters and reload page
  function updateFiltersAndReload() {
    const params = new URLSearchParams(window.location.search);
    
    // Update URL parameters with current filter values
    const year = yearFilter ? yearFilter.value : '';
    const month = monthFilter ? monthFilter.value : '';
    const developer = developerFilter ? developerFilter.value : '';
    const property = propertyFilter ? propertyFilter.value : '';
    const user = userFilter ? userFilter.value : '';
    const team = teamFilter ? teamFilter.value : '';
    
    // Set or remove parameters
    if (year) params.set('year', year);
    else params.delete('year');
    
    if (month) params.set('month', month);
    else params.delete('month');
    
    if (developer) params.set('developer', developer);
    else params.delete('developer');
    
    if (property) params.set('property', property);
    else params.delete('property');
    
    if (user) params.set('user', user);
    else params.delete('user');
    
    if (team) params.set('team', team);
    else params.delete('team');
    
    // Reset to page 1 when filters change
    params.delete('page');
    
    // Reload page with new parameters
    window.location.search = params.toString();
  }
  
  // Add event listeners for filter dropdowns
  if (yearFilter) yearFilter.addEventListener('change', updateFiltersAndReload);
  if (monthFilter) monthFilter.addEventListener('change', updateFiltersAndReload);
  if (developerFilter) developerFilter.addEventListener('change', updateFiltersAndReload);
  if (propertyFilter) propertyFilter.addEventListener('change', updateFiltersAndReload);
  if (userFilter) userFilter.addEventListener('change', updateFiltersAndReload);
  if (teamFilter) teamFilter.addEventListener('change', updateFiltersAndReload);
  
  // Filter function for search and status (client-side filtering)
  function filterTranches() {
    const searchTerm = searchInput.value.toLowerCase();
    const statusValue = statusFilter.value;
    const dateValue = dateFilter ? dateFilter.value : '';
    
    trancheCards.forEach(card => {
      const project = card.dataset.project;
      const agent = card.dataset.agent;
      const buyer = card.dataset.buyer;
      const status = card.dataset.status;
      const date = card.dataset.date;
      
      let showCard = true;
      
      // Search filter
      if (searchTerm) {
        showCard = project.includes(searchTerm) || 
                   agent.includes(searchTerm) || 
                   buyer.includes(searchTerm);
      }
      
      // Status filter
      if (statusValue && showCard) {
        if (statusValue === 'active_pending') {
          showCard = status !== 'completed';
        } else if (statusValue === 'completed') {
          showCard = status === 'completed';
        }
      }
      
      // Date filter
      if (dateValue && showCard) {
        const today = new Date();
        const trancheDate = new Date(date);
        
        switch(dateValue) {
          case 'today':
            showCard = trancheDate.toDateString() === today.toDateString();
            break;
          case 'week':
            const weekAgo = new Date(today - 7 * 24 * 60 * 60 * 1000);
            showCard = trancheDate >= weekAgo;
            break;
          case 'month':
            showCard = trancheDate.getMonth() === today.getMonth() && 
                      trancheDate.getFullYear() === today.getFullYear();
            break;
          case 'year':
            showCard = trancheDate.getFullYear() === today.getFullYear();
            break;
        }
      }
      
      card.style.display = showCard ? 'block' : 'none';
    });
  }
  
  // Add event listeners for search and status filters
  if (searchInput) searchInput.addEventListener('input', filterTranches);
  if (statusFilter) statusFilter.addEventListener('change', filterTranches);
  if (dateFilter) dateFilter.addEventListener('change', filterTranches);
  
  // Animate progress bars
  document.querySelectorAll('.progress-bar').forEach(bar => {
    setTimeout(() => {
      bar.style.width = bar.style.width; // Trigger animation
    }, 150);
  });
  
  // Initialize with any URL parameters for search and status
  const urlParams = new URLSearchParams(window.location.search);
  const searchParam = urlParams.get('search');
  const statusParam = urlParams.get('status');
  const dateParam = urlParams.get('date');
  
  if (searchParam && searchInput) {
    searchInput.value = searchParam;
  }
  
  if (statusParam && statusFilter) {
    statusFilter.value = statusParam;
  }
  
  if (dateParam && dateFilter) {
    dateFilter.value = dateParam;
  }
  
  filterTranches();
});
</script>

{% endblock %}