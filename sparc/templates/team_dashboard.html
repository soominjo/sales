{% extends "index.html" %}
{% block content %}
{% load humanize %}
{% load static %}
{% load custom_filters %}


<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{{ team_name }} Dashboard - Inner SPARC Realty Corporation</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        .gradient-bg {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        }
        .card-hover {
            transition: all 0.3s ease;
        }
        .card-hover:hover {
            transform: translateY(-5px);
            box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);
        }
        .chart-container {
            position: relative;
            height: 300px;
            width: 100%;
        }
        .no-data-state {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            height: 300px;
            color: #6b7280;
        }
        .member-card {
            transition: all 0.3s ease;
        }
        .member-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.1);
        }
        
        /* Style for select dropdown options */
        select option {
            background-color: #4a5568; /* Dark background for dropdown items */
            color: white;
        }
        
        /* Style for select dropdown hover/selected states */
        select option:hover,
        select option:focus,
        select option:checked {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }
        
        /* Style for the select element itself */
        select {
            -webkit-appearance: none;
            -moz-appearance: none;
            appearance: none;
            background-image: url("data:image/svg+xml;utf8,<svg fill='white' height='24' viewBox='0 0 24 24' width='24' xmlns='http://www.w3.org/2000/svg'><path d='M7 10l5 5 5-5z'/><path d='M0 0h24v24H0z' fill='none'/></svg>");
            background-repeat: no-repeat;
            background-position: right 0.5rem center;
            background-size: 1.5em;
            padding-right: 2.5rem;
        }
    </style>
</head>
<body class="bg-gray-50">
    <!-- Header -->
    <div class="bg-white shadow-sm border-b">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex flex-col lg:flex-row items-center justify-between py-6 gap-4">
                <div class="flex items-center space-x-4">
                    <div class="w-16 h-16 gradient-bg rounded-xl flex items-center justify-center">
                        <i class="fas fa-users text-white text-2xl"></i>
                    </div>
                    <div>
                        <h1 class="text-2xl lg:text-3xl font-bold text-gray-900">{{ team_name }} Dashboard</h1>
                        <p class="text-gray-600">Team Performance Overview</p>
                    </div>
                </div>

                <div class="flex flex-wrap items-center gap-3">
                    <!-- Filters -->
                    <div class="flex items-center gap-2 gradient-bg p-2 rounded-lg">
                        <select id="periodSelect" class="border-0 bg-transparent text-sm font-medium text-white focus:ring-0" onchange="handlePeriodChange()">
                            <option value="monthly" {% if selected_period == 'monthly' %}selected{% endif %}>Date</option>
                            <option value="yearly" {% if selected_period == 'yearly' %}selected{% endif %}>Yearly</option>
                        </select>

                        <div id="monthYearFilters" style="{% if selected_period == 'yearly' %}display: none;{% endif %}">
                            <select id="monthSelect" class="border-0 bg-transparent text-sm font-medium text-white focus:ring-0 focus:outline-none hover:text-white">
                                <option value="1" {% if selected_month == '1' %}selected{% endif %}>Jan</option>
                                <option value="2" {% if selected_month == '2' %}selected{% endif %}>Feb</option>
                                <option value="3" {% if selected_month == '3' %}selected{% endif %}>Mar</option>
                                <option value="4" {% if selected_month == '4' %}selected{% endif %}>Apr</option>
                                <option value="5" {% if selected_month == '5' %}selected{% endif %}>May</option>
                                <option value="6" {% if selected_month == '6' %}selected{% endif %}>Jun</option>
                                <option value="7" {% if selected_month == '7' %}selected{% endif %}>Jul</option>
                                <option value="8" {% if selected_month == '8' %}selected{% endif %}>Aug</option>
                                <option value="9" {% if selected_month == '9' %}selected{% endif %}>Sep</option>
                                <option value="10" {% if selected_month == '10' %}selected{% endif %}>Oct</option>
                                <option value="11" {% if selected_month == '11' %}selected{% endif %}>Nov</option>
                                <option value="12" {% if selected_month == '12' %}selected{% endif %}>Dec</option>
                            </select>
                            <input type="number" id="yearSelect" min="2000" max="2100" value="{{ selected_year }}" class="border-0 bg-transparent text-sm font-medium text-white focus:ring-0 w-20" onchange="applyFilters()" onkeyup="if(event.key==='Enter')applyFilters()" />
                        </div>
                    </div>

                    <a href="{% url 'dashboard' %}" class="gradient-bg text-white px-4 py-2 rounded-lg font-medium hover:opacity-90 transition-opacity">
                        <i class="fas fa-arrow-left mr-2"></i>Back to Main Dashboard
                    </a>
                </div>
            </div>
        </div>
    </div>

    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
        <!-- Stats Cards -->
        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-8">
            <div class="bg-white rounded-xl shadow-sm border border-gray-200 card-hover">
                <div class="p-6">
                    <div class="flex items-center justify-between">
                        <div>
                            <div class="flex items-center gap-2 mb-2">
                                <i class="fas fa-chart-line text-indigo-500 text-lg"></i>
                                <p class="text-sm font-medium text-gray-600">Team Total Sales</p>
                            </div>
                            <p class="text-3xl font-bold text-gray-900">₱{{ total_sales|floatformat:2|intcomma }}</p>
                            <p class="text-sm text-indigo-600 font-medium">100% team sales</p>
                        </div>
                    </div>
                </div>
                <div class="h-1 bg-indigo-500 rounded-b-xl"></div>
            </div>

            <div class="bg-white rounded-xl shadow-sm border border-gray-200 card-hover">
                <div class="p-6">
                    <div class="flex items-center justify-between">
                        <div>
                            <div class="flex items-center gap-2 mb-2">
                                <i class="fas fa-home text-green-500 text-lg"></i>
                                <p class="text-sm font-medium text-gray-600">Team Active Sales</p>
                            </div>
                            <p class="text-3xl font-bold text-gray-900">₱{{ active_sales|floatformat:2|intcomma }}</p>
                            <p class="text-sm text-green-600 font-medium">{{ active_percentage|floatformat:1 }}% of team sales</p>
                        </div>
                    </div>
                </div>
                <div class="h-1 bg-green-500 rounded-b-xl"></div>
            </div>

            <div class="bg-white rounded-xl shadow-sm border border-gray-200 card-hover">
                <div class="p-6">
                    <div class="flex items-center justify-between">
                        <div>
                            <div class="flex items-center gap-2 mb-2">
                                <i class="fas fa-ban text-red-500 text-lg"></i>
                                <p class="text-sm font-medium text-gray-600">Team Cancelled Sales</p>
                            </div>
                            <p class="text-3xl font-bold text-gray-900">₱{{ cancelled_sales|floatformat:2|intcomma }}</p>
                            <p class="text-sm text-red-600 font-medium">{{ cancelled_percentage|floatformat:1 }}% of team sales</p>
                        </div>
                    </div>
                </div>
                <div class="h-1 bg-red-500 rounded-b-xl"></div>
            </div>

            <div class="bg-white rounded-xl shadow-sm border border-gray-200 card-hover">
                <div class="p-6">
                    <div class="flex items-center justify-between">
                        <div>
                            <div class="flex items-center gap-2 mb-2">
                                <i class="fas fa-users text-blue-500 text-lg"></i>
                                <p class="text-sm font-medium text-gray-600">Team Members</p>
                            </div>
                            <p class="text-3xl font-bold text-gray-900">{{ approved_members_count }}</p>
                            <p class="text-sm text-gray-600 font-medium">Active team members</p>
                        </div>
                    </div>
                </div>
                <div class="h-1 bg-blue-500 rounded-b-xl"></div>
            </div>
        </div>

        <!-- Team Members Section -->
        <div class="bg-white rounded-xl shadow-sm border border-gray-200 mb-8">
            <div class="p-6 border-b border-gray-200">
                <h2 class="text-2xl font-bold text-indigo-800">Team Members Performance</h2>
                <p class="text-sm text-gray-500 mt-1">Top performers in {{ team_name }}</p>
            </div>
            
            <div class="p-6">
                {% if team_members %}
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                    {% for member in team_members %}
                    <div class="member-card bg-gradient-to-br from-white to-gray-50 rounded-xl border p-6">
                        <div class="flex items-center gap-4 mb-4">
                            <div class="w-16 h-16 rounded-full overflow-hidden border-4 border-gradient-to-br from-blue-400 to-indigo-400">
                                {% if member.user.profile.image %}
                                <img src="{{ member.user.profile.image.url }}" alt="{{ member.user.get_full_name }}" class="w-full h-full object-cover">
                                {% else %}
                                <div class="w-full h-full bg-gradient-to-br from-blue-400 to-indigo-400 flex items-center justify-center text-white font-bold text-lg">
                                    {{ member.user.first_name.0 }}{{ member.user.last_name.0 }}
                                </div>
                                {% endif %}
                            </div>
                            <div>
                                <h3 class="font-semibold text-gray-900">{{ member.user.get_full_name }}</h3>
                                <p class="text-sm text-gray-600">{{ member.user.profile.role }}</p>
                            </div>
                        </div>
                        
                        <div class="space-y-3">
                            <div class="flex justify-between items-center">
                                <span class="text-sm text-gray-600">Total Sales:</span>
                                <span class="font-bold text-green-700">₱{{ member.total_sales|floatformat:2|intcomma }}</span>
                            </div>
                            <div class="flex justify-between items-center">
                                <span class="text-sm text-gray-600">Active Count:</span>
                                <span class="px-2 py-1 bg-blue-100 text-blue-700 rounded text-xs">{{ member.active_count }}</span>
                            </div>
                            <div class="flex justify-between items-center">
                                <span class="text-sm text-gray-600">Growth:</span>
                                <span class="font-semibold {% if member.growth_percentage >= 0 %}text-green-600{% else %}text-red-600{% endif %}">
                                    {% if member.growth_percentage >= 0 %}+{% endif %}{{ member.growth_percentage|floatformat:0|intcomma }}%
                                </span>
                            </div>
                        </div>
                    </div>
                    {% endfor %}
                </div>
                {% else %}
                <div class="text-center py-8 text-gray-500">
                    <i class="fas fa-users text-4xl text-gray-300 mb-4"></i>
                    <p>No team members found.</p>
                </div>
                {% endif %}
            </div>
        </div>

        <!-- Charts Section -->
        <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
            <div class="bg-white rounded-xl shadow-sm border border-gray-200">
                <div class="p-6 border-b border-gray-200">
                    <h3 class="text-lg font-semibold text-gray-900 flex items-center gap-2">
                        <i class="fas fa-chart-bar text-blue-500"></i>
                        Project Sales Overview
                    </h3>
                </div>
                <div class="p-6">
                    {% if has_data %}
                    <div class="chart-container">
                        <canvas id="projectChart"></canvas>
                    </div>
                    {% else %}
                    <div class="no-data-state">
                        <i class="fas fa-building text-4xl text-gray-300 mb-4"></i>
                        <p class="text-gray-600">No project data available</p>
                        <p class="text-sm text-gray-500">Data will appear when sales are recorded</p>
                    </div>
                    {% endif %}
                </div>
            </div>

            <div class="bg-white rounded-xl shadow-sm border border-gray-200">
                <div class="p-6 border-b border-gray-200">
                    <h3 class="text-lg font-semibold text-gray-900 flex items-center gap-2">
                        <i class="fas fa-calendar text-green-500"></i>
                        Monthly Team Performance
                    </h3>
                </div>
                <div class="p-6">
                    {% if has_data %}
                    <div class="chart-container">
                        <canvas id="monthlyTeamChart"></canvas>
                    </div>
                    {% else %}
                    <div class="no-data-state">
                        <i class="fas fa-calendar text-4xl text-gray-300 mb-4"></i>
                        <p class="text-gray-600">No monthly data available</p>
                        <p class="text-sm text-gray-500">Data will appear when sales are recorded</p>
                    </div>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>

    <script>
        // Handle period change
        function handlePeriodChange() {
            const period = document.getElementById('periodSelect').value;
            const monthYearFilters = document.getElementById('monthYearFilters');
            
            if (period === 'yearly') {
                monthYearFilters.style.display = 'none';
            } else {
                monthYearFilters.style.display = 'block';
            }
            
            applyFilters();
        }

        // Apply filters
        function applyFilters() {
            const period = document.getElementById('periodSelect').value;
            const month = document.getElementById('monthSelect').value;
            const year = document.getElementById('yearSelect').value;
            
            // Validate year input
            const currentYear = new Date().getFullYear();
            let validYear = parseInt(year) || currentYear;
            validYear = Math.max(2000, Math.min(2100, validYear)); // Keep year between 2000-2100
            
            let url = new URL(window.location);
            url.searchParams.set('period', period);
            
            if (period === 'monthly') {
                url.searchParams.set('month', month);
                url.searchParams.set('year', validYear);
            } else {
                url.searchParams.set('year', validYear);
                url.searchParams.delete('month');
            }
            
            window.location.href = url.toString();
        }

        // Initialize charts
        function initializeCharts() {
            {% if has_data %}
            // Developer Chart
            const developerCtx = document.getElementById('developerChart').getContext('2d');
            new Chart(developerCtx, {
                type: 'bar',
                data: {
                    labels: {{ developers_json|safe }},
                    datasets: [{
                        label: 'Active Sales',
                        data: {{ developer_active_json|safe }},
                        backgroundColor: '#22c55e',
                        borderRadius: 4
                    }, {
                        label: 'Cancelled Sales',
                        data: {{ developer_cancelled_json|safe }},
                        backgroundColor: '#ef4444',
                        borderRadius: 4
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'top',
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    return context.dataset.label + ': ₱' + context.raw.toLocaleString();
                                }
                            }
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                callback: function(value) {
                                    return '₱' + value.toLocaleString();
                                }
                            }
                        }
                    }
                }
            });

            // Monthly Team Chart
            const monthlyData = {{ monthly_data|safe }};
            if (monthlyData.labels && monthlyData.labels.length > 0) {
                const monthlyCtx = document.getElementById('monthlyTeamChart').getContext('2d');
                new Chart(monthlyCtx, {
                    type: 'line',
                    data: monthlyData,
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: {
                                position: 'top',
                            },
                            tooltip: {
                                callbacks: {
                                    label: function(context) {
                                        return context.dataset.label + ': ₱' + context.raw.toLocaleString();
                                    }
                                }
                            }
                        },
                        scales: {
                            y: {
                                beginAtZero: true,
                                ticks: {
                                    callback: function(value) {
                                        return '₱' + value.toLocaleString();
                                    }
                                }
                            }
                        }
                    }
                });
            }

            // Project Sales Chart
            const projectData = {{ project_data|safe }};
            if (projectData.labels && projectData.labels.length > 0) {
                const projectCtx = document.getElementById('projectChart').getContext('2d');
                new Chart(projectCtx, {
                    type: 'bar',
                    data: projectData,
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: {
                                position: 'top',
                            },
                            tooltip: {
                                callbacks: {
                                    label: function(context) {
                                        return context.dataset.label + ': ₱' + context.raw.toLocaleString();
                                    }
                                }
                            }
                        },
                        scales: {
                            y: {
                                beginAtZero: true,
                                ticks: {
                                    callback: function(value) {
                                        return '₱' + value.toLocaleString();
                                    }
                                }
                            }
                        }
                    }
                });
            }
            {% endif %}
        }

        // Initialize everything when page loads
        document.addEventListener('DOMContentLoaded', function() {
            initializeCharts();
            
            // Add event listeners for filter changes
            document.getElementById('monthSelect').addEventListener('change', applyFilters);
            document.getElementById('yearSelect').addEventListener('change', applyFilters);
        });
    </script>
</body>
</html>

{% endblock %}
