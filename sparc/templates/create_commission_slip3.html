{% extends "index.html" %}

{% block content %}

{% load static %}
{% load widget_tweaks %}

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Supervisor-Agent Commission Slip</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
</head>

<body class="bg-gray-50">
    <div class="min-h-screen py-6 px-4 sm:px-6 lg:px-8">
        <div class="max-w-6xl mx-auto">
            <!-- Header Card -->
            <div class="bg-gradient-to-r from-blue-700 to-indigo-800 rounded-2xl shadow-xl overflow-hidden mb-8">
                <div class="p-6 md:p-8">
                    <div class="flex flex-col md:flex-row items-center space-y-6 md:space-y-0 md:space-x-8">
                        <div class="bg-white p-3 rounded-2xl shadow-lg">
                            <img src="{% static 'media/LOGO.png' %}" alt="Company Logo" class="w-16 h-16 md:w-20 md:h-20 object-contain"> 
                        </div>
                        <div class="text-center md:text-left text-white">
                            <h2 class="text-2xl md:text-3xl font-bold mb-2">Inner SPARC Realty Corporation</h2>
                            <div class="text-sm md:text-base space-y-1 opacity-90">
                                <p>Main Office: Block 26 Lot 4 Phase 3 Avida Residences Sta. Catalina</p>
                                <p>Salawag, Dasmari√±as, Cavite 4114</p>
                                <p>63917-853-4875/63999-994-3304/(046)458 0706</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Main Form -->
            <div class="bg-white rounded-2xl shadow-xl p-6 md:p-8">
                <h1 class="text-2xl md:text-3xl font-bold text-center text-gray-800 mb-6">
                    <span class="bg-clip-text text-transparent bg-gradient-to-r from-blue-600 to-indigo-600">
                        Create Supervisor-Agent Commission Slip
                    </span>
                </h1>

                <!-- Commission Slip Type Selector -->
                <div class="flex justify-center mb-8">
                    <div class="flex rounded-xl shadow-sm bg-gray-100 p-1 gap-1">
                        {% if user.is_superuser or user.is_staff %}
                            <a href="{% url 'create_commission_slip' %}" class="px-4 py-2 text-sm font-medium text-gray-700 bg-white rounded-lg hover:bg-gray-50 transition-colors">Agent</a>
                            <a href="{% url 'create_commission_slip2' %}" class="px-4 py-2 text-sm font-medium text-gray-700 bg-white rounded-lg hover:bg-gray-50 transition-colors">Management</a>
                            <a href="{% url 'create_commission_slip3' %}" class="px-4 py-2 text-sm font-medium text-white bg-blue-600 rounded-lg">Supervisor-Agent</a>
                        {% elif user.profile.role == 'Sales Manager' or user.profile.role == 'Sales Supervisor' %}
                            <a href="{% url 'create_commission_slip' %}" class="px-4 py-2 text-sm font-medium text-gray-700 bg-white rounded-lg hover:bg-gray-50 transition-colors">Agent</a>
                            <a href="{% url 'create_commission_slip3' %}" class="px-4 py-2 text-sm font-medium text-white bg-blue-600 rounded-lg">Supervisor-Agent</a>
                        {% endif %}
                    </div>
                </div>

                <form method="POST" action="{% url 'create_commission_slip3' %}" class="space-y-8">
                    {% csrf_token %}

                    <!-- Project Details Section -->
                    <div class="bg-blue-50 rounded-2xl p-6 border border-blue-100">
                        <div class="flex items-center mb-6">
                            <div class="h-8 w-1 bg-blue-600 rounded-full mr-3"></div>
                            <h2 class="text-xl font-semibold text-gray-800">Project Details</h2>
                        </div>
                        
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                            <!-- Agent Selection -->
                            <div>
                                <label for="agent_select" class="block text-sm font-medium text-gray-700 mb-2">
                                    <i class="fas fa-user-tag mr-2 text-blue-500"></i>Select Agent
                                </label>
                                <select id="agent_select" 
                                        class="w-full p-3 border border-gray-200 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 bg-white shadow-sm"
                                        onchange="updateAgentInfo()">
                                    <option value="">Select an agent</option>
                                    {% for user in active_agents %}
                                        <option value="{{ user.id }}" 
                                                data-name="{{ user.get_full_name }}"
                                                data-position="{{ user.profile.role }}"
                                                data-team="{{ user.profile.team.name }}">
                                            {{ user.get_full_name }} ({{ user.profile.team.display_name }})
                                        </option>
                                    {% endfor %}
                                </select>
                            </div>

                            <!-- Agent Name -->
                            <div>
                                <label for="sales_agent_name" class="block text-sm font-medium text-gray-700 mb-2">
                                    <i class="fas fa-signature mr-2 text-blue-500"></i>Agent Name
                                </label>
                                <input type="text" name="sales_agent_name" id="agent_name_display" readonly
                                       class="w-full p-3 border border-gray-200 rounded-lg bg-gray-50 shadow-sm">
                            </div>

                            <!-- Supervisor Selection -->
                            <div>
                                <label for="supervisor_id" class="block text-sm font-medium text-gray-700 mb-2">
                                    <i class="fas fa-user-shield mr-2 text-blue-500"></i>Select Supervisor
                                </label>
                                <select name="supervisor_id" id="supervisor_id" required
                                        class="w-full p-3 border border-gray-200 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 shadow-sm bg-white"
                                        onchange="updateSupervisorDetails()">
                                    <option value="">Select a supervisor</option>
                                    {% for user in active_supervisors %}
                                        <option value="{{ user.id }}" 
                                                data-name="{{ user.get_full_name }}"
                                                data-position="{{ user.profile.role }}"
                                                data-team="{{ user.profile.team.name }}">
                                            {{ user.get_full_name }} ({{ user.profile.team.display_name }})
                                        </option>
                                    {% endfor %}
                                </select>
                            </div>
                            
                            <!-- Supervisor Name -->
                            <div>
                                <label for="supervisor_name" class="block text-sm font-medium text-gray-700 mb-2">
                                    <i class="fas fa-signature mr-2 text-blue-500"></i>Supervisor Name
                                </label>
                                <input type="text" name="supervisor_name" id="supervisor_name_display" readonly
                                       class="w-full p-3 border border-gray-200 rounded-lg bg-gray-50 shadow-sm">
                            </div>

                            <!-- Sales Manager Selection -->
                            <div>
                                <label for="manager_id" class="block text-sm font-medium text-gray-700 mb-2">
                                    <i class="fas fa-user-tie mr-2 text-blue-500"></i>Select Sales Manager
                                </label>
                                <select id="manager_id" name="manager_id"
                                        class="w-full p-3 border border-gray-200 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 shadow-sm bg-white"
                                        onchange="updateManagerDetails()">
                                    <option value="">Select a manager</option>
                                    {% for user in active_managers %}
                                        <option value="{{ user.id }}" data-name="{{ user.get_full_name }}">
                                            {{ user.get_full_name }} ({{ user.profile.team.display_name }})
                                        </option>
                                    {% endfor %}
                                </select>
                            </div>

                            <!-- Sales Manager Name -->
                            <div>
                                <label for="sales_manager_name" class="block text-sm font-medium text-gray-700 mb-2">
                                    <i class="fas fa-signature mr-2 text-blue-500"></i>Sales Manager Name
                                </label>
                                <input type="text" name="sales_manager_name" id="sales_manager_name_display" readonly
                                       class="w-full p-3 border border-gray-200 rounded-lg bg-gray-50 shadow-sm">
                            </div>

                            <!-- Buyer Name -->
                            <div>
                                <label for="buyer_name" class="block text-sm font-medium text-gray-700 mb-2">
                                    <i class="fas fa-user mr-2 text-blue-500"></i>Buyer Name
                                </label>
                                {{ slip_form.buyer_name|add_class:"w-full p-3 border border-gray-200 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 shadow-sm" }}
                            </div>

                          <!-- Project Name -->
<div>
    <label for="project_name" class="block text-sm font-medium text-gray-700 mb-2">
        <i class="fas fa-building mr-2 text-blue-500"></i>Project Name
    </label>
    <select name="project_name" id="project_name" class="w-full p-3 border border-gray-200 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 shadow-sm bg-white" required>
        <option value="">Select a project</option>
        {% for property in properties %}
            <option value="{{ property.name }}">{{ property.name }}{% if property.developer %} - {{ property.developer.name }}{% endif %}</option>
        {% endfor %}
    </select>
</div>

                            <!-- Unit ID -->
                            <div>
                                <label for="unit_id" class="block text-sm font-medium text-gray-700 mb-2">
                                    <i class="fas fa-home mr-2 text-blue-500"></i>Unit ID
                                </label>
                                {{ slip_form.unit_id|add_class:"w-full p-3 border border-gray-200 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 shadow-sm" }}
                            </div>
                        </div>
                    </div>

                    <!-- Commission Details Section -->
                    <div class="bg-blue-50 rounded-2xl p-6 border border-blue-100">
                        <div class="flex items-center mb-6">
                            <div class="h-8 w-1 bg-blue-600 rounded-full mr-3"></div>
                            <h2 class="text-xl font-semibold text-gray-800">Commission Details</h2>
                        </div>
                        
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                            <!-- Total Selling Price -->
                            <div>
                                <label for="total_selling_price" class="block text-sm font-medium text-gray-700 mb-2">
                                    <i class="fas fa-money-bill-wave mr-2 text-blue-500"></i>Total Selling Price
                                </label>
                                <div class="relative">
                                    <span class="absolute left-3 top-3 text-gray-500">‚Ç±</span>
                                    <input type="number" step="0.01" name="total_selling_price" id="total_selling_price"
                                           class="w-full p-3 pl-8 border border-gray-200 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 shadow-sm"
                                           placeholder="Enter amount" required
                                           onchange="updateCommissionPreview()">
                                </div>
                            </div>

                            <!-- Agent Commission Rate -->
                            <div>
                                <label for="agent_commission_rate" class="block text-sm font-medium text-gray-700 mb-2">
                                    <i class="fas fa-percent mr-2 text-blue-500"></i>Agent Commission Rate
                                </label>
                                <div class="relative">
                                    <input type="number" step="0.01" name="agent_commission_rate" id="agent_commission_rate" value="3.00"
                                           class="w-full p-3 pr-8 border border-gray-200 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 shadow-sm"
                                           placeholder="Enter rate" required
                                           onchange="updateCommissionPreview()">
                                    <span class="absolute right-3 top-3 text-gray-500">%</span>
                                </div>
                            </div>

                            <!-- Supervisor Commission Rate -->
                            <div>
                                <label for="supervisor_commission_rate" class="block text-sm font-medium text-gray-700 mb-2">
                                    <i class="fas fa-percent mr-2 text-blue-500"></i>Supervisor Commission Rate
                                </label>
                                <div class="relative">
                                    <input type="number" step="0.01" name="supervisor_commission_rate" id="supervisor_commission_rate" value="0.50"
                                           class="w-full p-3 pr-8 border border-gray-200 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 shadow-sm"
                                           placeholder="Enter rate" required
                                           onchange="updateCommissionPreview()">
                                    <span class="absolute right-3 top-3 text-gray-500">%</span>
                                </div>
                            </div>

                            <!-- Sales Manager Commission Rate -->
                            <div>
                                <label for="manager_commission_rate" class="block text-sm font-medium text-gray-700 mb-2">
                                    <i class="fas fa-percent mr-2 text-blue-500"></i>Sales Manager Commission Rate
                                </label>
                                <div class="relative">
                                    <input type="number" step="0.01" id="manager_commission_rate" name="manager_commission_rate" value="0.50"
                                           class="w-full p-3 pr-8 border border-gray-200 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 shadow-sm"
                                           onchange="updateCommissionPreview()">
                                    <span class="absolute right-3 top-3 text-gray-500">%</span>
                                </div>
                            </div>

                            <!-- Particulars -->
                            <div>
                                <label for="particulars" class="block text-sm font-medium text-gray-700 mb-2">
                                    <i class="fas fa-list mr-2 text-blue-500"></i>Particulars
                                </label>
                                <select name="particulars[]" id="particulars"
                                        class="w-full p-3 border border-gray-200 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 shadow-sm bg-white"
                                        onchange="updateFieldsVisibility(); updateCommissionPreview();">
                                    <option value="FULL COMM">FULL COMM</option>
                                    <option value="PARTIAL COMM">PARTIAL COMM</option>
                                    <option value="INCENTIVES">INCENTIVES</option>
                                    <option value="CASH ADVANCE">CASH ADVANCE</option>
                                </select>
                            </div>

                            <!-- Percentage for Partial Commission -->
                            <div class="partial-field" style="display: none;">
                                <label for="partial_percentage" class="block text-sm font-medium text-gray-700 mb-2">
                                    <i class="fas fa-chart-pie mr-2 text-blue-500"></i>Percentage of Commission Amount
                                </label>
                                <div class="relative">
                                    <input type="number" step="0.01" name="partial_percentage" id="partial_percentage" value="100"
                                           class="w-full p-3 pr-8 border border-gray-200 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 shadow-sm"
                                           placeholder="Enter percentage"
                                           onchange="updateCommissionPreview()">
                                    <span class="absolute right-3 top-3 text-gray-500">%</span>
                                </div>
                            </div>

                            <!-- Incentive Amount (Hidden by default) -->
                            <div class="incentive-field" style="display: none;">
                                <label for="incentive_amount" class="block text-sm font-medium text-gray-700 mb-2">
                                    <i class="fas fa-gift mr-2 text-blue-500"></i>Incentive Amount
                                </label>
                                <div class="relative">
                                    <span class="absolute left-3 top-3 text-gray-500">‚Ç±</span>
                                    <input type="number" step="0.01" name="incentive_amount" id="incentive_amount" value="0"
                                           class="w-full p-3 pl-8 border border-gray-200 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 shadow-sm"
                                           onchange="updateCommissionPreview()">
                                </div>
                            </div>

                            <!-- Cash Advance -->
                            <div class="cash-advance-field" style="display: none;">
                                <label for="cash_advance" class="block text-sm font-medium text-gray-700 mb-2">
                                    <i class="fas fa-money-check mr-2 text-blue-500"></i>Cash Advance
                                </label>
                                <div class="relative">
                                    <span class="absolute left-3 top-3 text-gray-500">‚Ç±</span>
                                    <input type="number" step="0.01" name="cash_advance" id="cash_advance"
                                           class="w-full p-3 pl-8 border border-gray-200 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 shadow-sm"
                                           placeholder="Enter cash advance amount" value="0"
                                           onchange="updateCommissionPreview()">
                                </div>
                                <p class="text-sm text-gray-500 mt-1">10% tax will be automatically deducted</p>
                            </div>

                            <!-- Withholding Tax Rate (Agent) -->
                            <div>
                                <label for="withholding_tax_rate" class="block text-sm font-medium text-gray-700 mb-2">
                                    <i class="fas fa-file-invoice-dollar mr-2 text-blue-500"></i>Agent Withholding Tax Rate
                                </label>
                                <div class="relative">
                                    <input type="number" step="0.01" name="withholding_tax_rate" id="withholding_tax_rate"
                                           class="w-full p-3 pr-8 border border-gray-200 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 shadow-sm bg-white"
                                           placeholder="Enter tax rate" value="10.00" min="0" max="100"
                                           onchange="updateCommissionPreview()" required>
                                    <span class="absolute right-3 top-3 text-gray-500">%</span>
                                </div>
                                <p class="text-sm text-gray-500 mt-1">Enter the withholding tax rate for agent as a percentage</p>
                            </div>

                            <!-- Withholding Tax Rate (Supervisor) -->
                            <div>
                                <label for="supervisor_withholding_tax_rate" class="block text-sm font-medium text-gray-700 mb-2">
                                    <i class="fas fa-file-invoice-dollar mr-2 text-blue-500"></i>Supervisor Withholding Tax Rate
                                </label>
                                <div class="relative">
                                    <input type="number" step="0.01" name="supervisor_withholding_tax_rate" id="supervisor_withholding_tax_rate"
                                           class="w-full p-3 pr-8 border border-gray-200 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 shadow-sm bg-white"
                                           placeholder="Enter tax rate" value="10.00" min="0" max="100"
                                           onchange="updateCommissionPreview()" required>
                                    <span class="absolute right-3 top-3 text-gray-500">%</span>
                                </div>
                                <p class="text-sm text-gray-500 mt-1">Enter the withholding tax rate for supervisor as a percentage</p>
                            </div>

                            <!-- Sales Manager Withholding Tax -->
                            <div>
                                <label for="manager_tax_rate" class="block text-sm font-medium text-gray-700 mb-2">
                                    <i class="fas fa-file-invoice-dollar mr-2 text-blue-500"></i>Sales Manager Withholding Tax
                                </label>
                                <div class="relative">
                                    <input type="number" step="0.01" id="manager_tax_rate" name="manager_tax_rate"
                                           value="10.00" class="w-full p-3 pr-8 border border-gray-200 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 shadow-sm"
                                           onchange="updateCommissionPreview()">
                                    <span class="absolute right-3 top-3 text-gray-500">%</span>
                                </div>
                            </div>

                            <!-- Date -->
                            <div>
                                <label for="date" class="block text-sm font-medium text-gray-700 mb-2">
                                    <i class="fas fa-calendar-alt mr-2 text-blue-500"></i>Date
                                </label>
                                <input type="date" name="date" id="date"
                                       class="w-full p-3 border border-gray-200 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 shadow-sm"
                                       required>
                            </div>
                        </div>

                        <!-- Commission Preview Table -->
                        <div class="mt-8 bg-white p-4 rounded-xl border border-gray-200 shadow-sm">
                            <h3 class="text-lg font-medium text-gray-700 mb-4 flex items-center">
                                <i class="fas fa-calculator mr-2 text-blue-500"></i>Commission Breakdown Preview
                            </h3>
                            <div class="overflow-x-auto">
                                <table class="w-full border-collapse rounded-lg overflow-hidden">
                                    <thead class="bg-blue-100">
                                        <tr>
                                            <th class="px-4 py-3 text-left text-xs font-medium text-gray-700 uppercase tracking-wider">Position</th>
                                            <th class="px-4 py-3 text-left text-xs font-medium text-gray-700 uppercase tracking-wider">Rate</th>
                                            <th class="px-4 py-3 text-left text-xs font-medium text-gray-700 uppercase tracking-wider">Percentage</th>
                                            <th class="px-4 py-3 text-left text-xs font-medium text-gray-700 uppercase tracking-wider">Gross Commission</th>
                                            <th class="px-4 py-3 text-left text-xs font-medium text-gray-700 uppercase tracking-wider">Tax</th>
                                            <th class="px-4 py-3 text-left text-xs font-medium text-gray-700 uppercase tracking-wider">Net Commission</th>
                                        </tr>
                                    </thead>
                                    <tbody class="bg-white divide-y divide-gray-200" id="previewTableBody">
                                        <!-- Preview rows will be populated by JavaScript -->
                                    </tbody>
                                    <tfoot class="bg-blue-50 font-semibold">
                                        <tr id="totalRow">
                                            <td class="px-4 py-3" colspan="3">TOTAL</td>
                                            <td class="px-4 py-3" id="totalGrossCommission">‚Ç±0.00</td>
                                            <td class="px-4 py-3" id="totalTax">‚Ç±0.00</td>
                                            <td class="px-4 py-3" id="totalNetCommission">‚Ç±0.00</td>
                                        </tr>
                                    </tfoot>
                                </table>
                            </div>
                        </div>
                    </div>

                    <!-- Submit and Back Buttons -->
                    <div class="flex flex-col sm:flex-row justify-center gap-4">
                        <a href="{% url 'commission_history' %}" 
                           class="inline-flex items-center justify-center px-6 py-3 text-base font-medium rounded-xl text-gray-700 bg-gray-100 hover:bg-gray-200 focus:outline-none shadow transition-all">
                            <i class="fas fa-arrow-left mr-2"></i>
                            <span class="hidden sm:inline">Go Back</span>
                            <span class="sm:hidden">Back</span>
                        </a>
                        <button type="submit" 
                                class="inline-flex items-center justify-center px-6 py-3 text-base font-medium rounded-xl text-white bg-gradient-to-r from-blue-600 to-indigo-600 hover:from-blue-700 hover:to-indigo-700 focus:outline-none shadow transition-all">
                            <i class="fas fa-save mr-2"></i>
                            Save Commission Slip
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <script>
        function formatCurrency(amount) {
            return amount.toLocaleString('en-US', {
                minimumFractionDigits: 2,
                maximumFractionDigits: 2
            });
        }

        function updateFieldsVisibility() {
            const particularsSelect = document.getElementById('particulars');
            const incentiveField = document.querySelector('.incentive-field');
            const partialField = document.querySelector('.partial-field');
            const selectedValue = particularsSelect.value;
            const cashAdvanceField = document.querySelector('.cash-advance-field');
            
            incentiveField.style.display = selectedValue === 'INCENTIVES' ? 'block' : 'none';
            partialField.style.display = selectedValue === 'PARTIAL COMM' ? 'block' : 'none';
            cashAdvanceField.style.display = selectedValue === 'CASH ADVANCE' ? 'block' : 'none';
            
            // Reset percentage to 100% if not PARTIAL COMM
            if (selectedValue !== 'PARTIAL COMM') {
                document.getElementById('partial_percentage').value = '100';
            }
            
            updateCommissionPreview();
        }

        function updateCommissionPreview() {
            const totalSellingPrice = parseFloat(document.getElementById('total_selling_price').value) || 0;
            const cashAdvance = parseFloat(document.getElementById('cash_advance').value) || 0;
            const particularsSelect = document.getElementById('particulars');
            const partialPercentageInput = document.getElementById('partial_percentage');
            const incentiveAmount = parseFloat(document.getElementById('incentive_amount').value) || 0;
            const agentCommissionRate = parseFloat(document.getElementById('agent_commission_rate').value) || 0;
            const supervisorCommissionRate = parseFloat(document.getElementById('supervisor_commission_rate').value) || 0;
            const managerCommissionRate = parseFloat(document.getElementById('manager_commission_rate').value) || 0;
            let partialPercentage = 100;

            // Get the partial percentage if PARTIAL COMM is selected
            if (particularsSelect.value === 'PARTIAL COMM') {
                partialPercentage = parseFloat(partialPercentageInput.value) || 100;
            }

            // Get separate tax rates for agent and supervisor
            const agentTaxRate = parseFloat(document.getElementById('withholding_tax_rate').value) || 10.00;
            const supervisorTaxRate = parseFloat(document.getElementById('supervisor_withholding_tax_rate').value) || 10.00;
            const managerTaxRate = parseFloat(document.getElementById('manager_tax_rate').value) || 10.00;

            // Calculate cash advance after tax (10% tax)
            const cashAdvanceTax = cashAdvance * 0.10;
            const netCashAdvance = cashAdvance - cashAdvanceTax;

            // Calculate adjusted total selling price
            const adjustedTotal = totalSellingPrice - netCashAdvance;

            // Clear existing preview rows
            const tableBody = document.getElementById('previewTableBody');
            tableBody.innerHTML = '';

            // Initialize totals
            let totalGrossCommission = 0;
            let totalTax = 0;
            let totalNetCommission = 0;

            // Process agent commission with agent tax rate
            if (agentCommissionRate > 0) {
                const fullCommission = adjustedTotal * agentCommissionRate / 100;
                const baseCommission = fullCommission * (partialPercentage / 100);
                let grossCommission = baseCommission;

                if (particularsSelect.value === 'INCENTIVES') {
                    grossCommission = baseCommission + incentiveAmount;
                }

                const withholdingTax = grossCommission * (agentTaxRate / 100);
                const netCommission = grossCommission - withholdingTax;

                // Add to totals
                totalGrossCommission += grossCommission;
                totalTax += withholdingTax;
                totalNetCommission += netCommission;

                const row = document.createElement('tr');
                row.innerHTML = `
                    <td class="px-4 py-3">Sales Agent</td>
                    <td class="px-4 py-3">${agentCommissionRate}%</td>
                    <td class="px-4 py-3">${partialPercentage}%</td>
                    <td class="px-4 py-3">‚Ç±${formatCurrency(grossCommission)}</td>
                    <td class="px-4 py-3">‚Ç±${formatCurrency(withholdingTax)} (${agentTaxRate}%)</td>
                    <td class="px-4 py-3 font-medium">‚Ç±${formatCurrency(netCommission)}</td>
                `;
                tableBody.appendChild(row);
            }

            // Process supervisor commission with supervisor tax rate
            if (supervisorCommissionRate > 0) {
                const fullCommission = adjustedTotal * supervisorCommissionRate / 100;
                const baseCommission = fullCommission * (partialPercentage / 100);
                let grossCommission = baseCommission;

                if (particularsSelect.value === 'INCENTIVES') {
                    grossCommission = baseCommission + incentiveAmount;
                }

                const withholdingTax = grossCommission * (supervisorTaxRate / 100);
                const netCommission = grossCommission - withholdingTax;

                // Add to totals
                totalGrossCommission += grossCommission;
                totalTax += withholdingTax;
                totalNetCommission += netCommission;

                const row = document.createElement('tr');
                row.innerHTML = `
                    <td class="px-4 py-3">Sales Supervisor</td>
                    <td class="px-4 py-3">${supervisorCommissionRate}%</td>
                    <td class="px-4 py-3">${partialPercentage}%</td>
                    <td class="px-4 py-3">‚Ç±${formatCurrency(grossCommission)}</td>
                    <td class="px-4 py-3">‚Ç±${formatCurrency(withholdingTax)} (${supervisorTaxRate}%)</td>
                    <td class="px-4 py-3 font-medium">‚Ç±${formatCurrency(netCommission)}</td>
                `;
                tableBody.appendChild(row);
            }

            // Process manager commission with manager tax rate
            if (managerCommissionRate > 0) {
                const fullCommission = adjustedTotal * managerCommissionRate / 100;
                const baseCommission = fullCommission * (partialPercentage / 100);
                let grossCommission = baseCommission;

                if (particularsSelect.value === 'INCENTIVES') {
                    grossCommission = baseCommission + incentiveAmount;
                }

                const withholdingTax = grossCommission * (managerTaxRate / 100);
                const netCommission = grossCommission - withholdingTax;

                // Add to totals
                totalGrossCommission += grossCommission;
                totalTax += withholdingTax;
                totalNetCommission += netCommission;

                const row = document.createElement('tr');
                row.innerHTML = `
                    <td class="px-4 py-3">Sales Manager</td>
                    <td class="px-4 py-3">${managerCommissionRate}%</td>
                    <td class="px-4 py-3">${partialPercentage}%</td>
                    <td class="px-4 py-3">‚Ç±${formatCurrency(grossCommission)}</td>
                    <td class="px-4 py-3">‚Ç±${formatCurrency(withholdingTax)} (${managerTaxRate}%)</td>
                    <td class="px-4 py-3 font-medium">‚Ç±${formatCurrency(netCommission)}</td>
                `;
                tableBody.appendChild(row);
            }

            // Update totals in the footer
            document.getElementById('totalGrossCommission').textContent = `‚Ç±${formatCurrency(totalGrossCommission)}`;
            document.getElementById('totalTax').textContent = `‚Ç±${formatCurrency(totalTax)}`;
            document.getElementById('totalNetCommission').textContent = `‚Ç±${formatCurrency(totalNetCommission)}`;
        }

        function updateAgentInfo() {
            const select = document.getElementById('agent_select');
            const selectedOption = select.options[select.selectedIndex];
            document.getElementById('agent_name_display').value = selectedOption.dataset.name || '';
        }

        function updateSupervisorDetails() {
            const select = document.getElementById('supervisor_id');
            const selectedOption = select.options[select.selectedIndex];
            document.getElementById('supervisor_name_display').value = selectedOption.dataset.name || '';
        }

        function updateManagerDetails() {
            const select = document.getElementById('manager_id');
            const selectedOption = select.options[select.selectedIndex];
            document.getElementById('sales_manager_name_display').value = selectedOption?.dataset.name || '';
        }

        // Initialize on page load
        document.addEventListener('DOMContentLoaded', function() {
            // Set default date to today
            const today = new Date().toISOString().split('T')[0];
            document.getElementById('date').value = today;
            
            updateFieldsVisibility();
            updateCommissionPreview();
            updateManagerDetails();
        });
    </script>
{% endblock %}
</body>