{% extends "index.html" %}

{% block content %}

{% load static %}
{% load humanize %}
{% load custom_filters %}

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Commission Slip</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @media print {
            /* Hide everything except the printable content */
            body * {
                visibility: hidden;
            }
            
            #printable-content, #printable-content * {
                visibility: visible;
            }
            
            #printable-content {
                position: absolute;
                left: 0;
                top: 0;
                width: 100%;
            }

            /* Hide specific elements */
            .no-print, 
            nav, 
            footer, 
            #print-button,
            .back-button {
                display: none !important;
            }

            /* Ensure white background */
            #printable-content {
                background-color: white !important;
                padding: 20px;
            }
        }

        /* Style for the buttons container */
        .action-buttons {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            justify-content: center;
            margin-top: 20px;
        }

        .action-button {
            padding: 10px 20px;
            border-radius: 8px;
            font-weight: bold;
            cursor: pointer;
            transition: background-color 0.3s;
            min-width: 120px;
            text-align: center;
        }

        .print-button {
            background-color: #22c55e;
            color: white;
        }

        .edit-button {
            background-color: #eab308;
            color: white;
        }

        .delete-button {
            background-color: #dc2626;
            color: white;
        }

        .print-button:hover {
            background-color: #16a34a;
        }

        .edit-button:hover {
            background-color: #ca8a04;
        }

        .delete-button:hover {
            background-color: #991b1b;
        }

        /* Add specific styling for content */
        #printable-content {
            max-width: 100%;
            margin: 0 auto;
            padding: 10px;
        }

        #printable-content table {
            width: 100% !important;
            margin-bottom: 20px;
            page-break-inside: avoid;
            font-size: 12px;
        }

        #printable-content td,
        #printable-content th {
            padding: 6px 8px;
            word-wrap: break-word;
        }

        /* Page settings */
        @page {
            margin: 15mm;
        }

        /* Ensure table cells don't wrap unnecessarily */
        .commission-table {
            border-collapse: collapse;
            width: 100%;
        }

        .commission-table td,
        .commission-table th {
            padding: 8px 12px;
            border: 1px solid #ddd;
        }

        /* Adjust font sizes for print */
        @media print {
            body {
                font-size: 12px;
            }
            h2 {
                font-size: 18px;
            }
            .text-sm {
                font-size: 10px;
            }
        }

        /* Mobile responsive adjustments */
        @media (max-width: 768px) {
            #printable-content {
                padding: 15px;
                margin: 10px;
            }
            
            .commission-table {
                font-size: 12px;
            }
            
            .commission-table td,
            .commission-table th {
                padding: 6px 8px;
            }
        }
    </style>
</head>

<!-- Back Button - No Print -->
<div class="flex justify-between items-center mb-4 px-4">
    {% if is_receivable_view %}
        <div class="flex items-center px-3 py-1 bg-green-100 text-green-800 rounded-full text-sm font-medium">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 mr-1" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"/>
            </svg>
            Receivable Voucher
        </div>
        <a href="{% url 'receivables' %}" 
           class="inline-flex items-center px-4 py-2 bg-gray-600 text-white rounded-lg hover:bg-gray-700 transition-colors duration-200">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 19l-7-7m0 0l7-7m-7 7h18"/>
            </svg>
            <span class="hidden sm:inline">Back to Receivables</span>
            <span class="sm:hidden">Back</span>
        </a>
    {% elif is_tranche_view %}
        <div class="flex items-center px-3 py-1 bg-blue-100 text-blue-800 rounded-full text-sm font-medium">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 mr-1" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4h16c1.1 0 2 .9 2 2v12c0 1.1-.9 2-2 2H4c-1.1 0-2-.9-2-2V6c0-1.1.9-2 2-2z"/>
                <line x1="2" y1="10" x2="22" y2="10"/>
            </svg>
            Tranche Voucher
        </div>
        <a href="{% url 'tranche_history' %}" 
           class="inline-flex items-center px-4 py-2 bg-gray-600 text-white rounded-lg hover:bg-gray-700 transition-colors duration-200">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 19l-7-7m0 0l7-7m-7 7h18"/>
            </svg>
            <span class="hidden sm:inline">Back to Tranches</span>
            <span class="sm:hidden">Back</span>
        </a>
    {% else %}
        <div></div>
        <a href="{% url 'commission_history' %}" 
           class="inline-flex items-center px-4 py-2 bg-gray-600 text-white rounded-lg hover:bg-gray-700 transition-colors duration-200">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 19l-7-7m0 0l7-7m-7 7h18"/>
            </svg>
            <span class="hidden sm:inline">Back to History</span>
            <span class="sm:hidden">Back</span>
        </a>
    {% endif %}
</div>

<!-- Printable Content -->
<div id="printable-content" class="bg-white shadow-lg rounded-lg p-4 sm:p-6 lg:p-8 w-full max-w-4xl mx-auto border-2 sm:border-4 border-blue-500">
    <div class="text-center border-b pb-4 mb-4">
        <img src="{% static 'media/LOGO.png' %}" alt="Company Logo" class="w-16 h-16 sm:w-20 sm:h-20 object-contain"> 
        <div class="mt-4">
            <h2 class="text-lg sm:text-xl lg:text-2xl font-bold text-gray-800">Inner SPARC Realty Corporation</h2>
            <p class="text-xs sm:text-sm text-gray-600 mt-2">
                Main Office: Block 26 Lot 4 Phase 3 Avida Residences Sta. Catalina, Salawag, Dasmariñas, Cavite 4114 <br class="hidden sm:block"> 
                <span class="sm:hidden">Salawag, Dasmariñas, Cavite 4114<br></span>
                63917-853-4875/63999-994-3304/(046)458 0706 <br>
                Inner SPARC Realty Services
            </p>
            <p class="text-lg sm:text-xl lg:text-2xl text-blue-700 text-center sm:text-right mt-2">
                <strong> {{ slip.date }} </strong>
            </p>
        </div>
    </div>

    <div class="grid grid-cols-1 sm:grid-cols-2 gap-2 sm:gap-4 text-gray-700 text-sm sm:text-base mb-4">
        <p><strong>Sales Agent: </strong> {{ slip.sales_agent_name }}</p>
        {% if slip.sales_manager_name %}
        <p><strong>Sales Manager: </strong> {{ slip.sales_manager_name }}</p>
        {% endif %}
        <p><strong>Buyer:</strong> {{ slip.buyer_name }}</p>
        <p><strong>Project Name:</strong> {{ slip.project_name }}</p>
        <p><strong>Unit ID:</strong> {{ slip.unit_id }}</p>
        {% if is_tranche_view %}
            <p><strong>TCP:</strong> ₱{{ slip.tcp|floatformat:2|intcomma }}</p>
            <p><strong>Lot Area:</strong> {{ slip.lot_area }}</p>
            <p><strong>Floor Area:</strong> {{ slip.floor_area }}</p>
        {% endif %}
        <p><strong>Total Selling Price:</strong> ₱{{ slip.total_selling_price|floatformat:2|intcomma }}</p>
        {% if slip.cash_advance > 0 %}
        <p><strong>Cash Advance (less 10% tax):</strong> ₱{{ slip.cash_advance_tax|floatformat:2|intcomma }}</p>
        {% endif %}
        {% if details.0.particulars == 'PARTIAL COMM' %}
            <p><strong>Percentage:</strong> {{ details.0.partial_percentage|floatformat:0 }}%</p>
        {% endif %}
        {% if slip.incentive_amount > 0 %}
            <p><strong>Additional Incentive:</strong> ₱{{ slip.incentive_amount|floatformat:2|intcomma }}</p>
        {% endif %}
    </div>
    
    <div class="overflow-x-auto">
        <table class="w-full mt-6 border border-gray-300 text-xs sm:text-sm text-gray-700 text-center commission-table">
            <thead class="bg-blue-500 text-white text-center">
                <tr>
                    <th class="p-2 border">Position</th>
                    <th class="p-2 border">Name</th>
                    <th class="p-2 border">Particulars</th>
                    <th class="p-2 border">Commission Rate</th>
                    <th class="p-2 border">Gross Commission</th>
                    <th class="p-2 border">Withholding Tax</th>
                    <th class="p-2 border">Net Commission</th>
                </tr>
            </thead>
            <tbody>
            {% for detail in details %}
                <tr>
                    <td class="p-2 border">{{ detail.position }}</td>
                    <td class="p-2 border">{{ detail.agent_name }}</td>
                    <td class="p-2 border">{{ detail.particulars }}</td>
                    <td class="p-2 border text-center">{{ detail.commission_rate|floatformat:2 }}%</td>
                    <td class="p-2 border">₱{{ detail.gross_commission|floatformat:2|intcomma }}</td>
                    <td class="p-2 border">₱{{ detail.withholding_tax|floatformat:2|intcomma }}</td>
                    <td class="p-2 border">₱{{ detail.net_commission|floatformat:2|intcomma }}</td>
                </tr>
            {% endfor %}
            
            {% if user.is_staff or user.is_superuser or user.profile.role == 'Sales Manager' %}
            <tr class="bg-gray-50 font-semibold">
                <td colspan="4" class="p-2 border text-right">Total:</td>
                <td class="p-2 border">₱{{ total_gross|floatformat:2|intcomma }}</td>
                <td class="p-2 border">₱{{ total_tax|floatformat:2|intcomma }}</td>
                <td class="p-2 border">₱{{ total_net|floatformat:2|intcomma }}</td>
            </tr>
            {% endif %}
            </tbody>
        </table>
    </div>

    <div class="mt-6 text-center text-gray-700 text-xs sm:text-sm space-y-2">
        <p>Prepared by: <span class="font-semibold">Shiela Mae F. Fajutagana</span> (Accounting Staff)</p>
        <p>Checked by: <span class="font-semibold">Gabriel V. Libacao Jr.</span> (Chief Executive Officer)</p>
        <p>Received by: <span class="font-semibold">{{ slip.sales_agent_name }}</span></p>
        
        <!-- Signature Area -->
        <div class="mt-6">
            <div id="signature-display" class="mb-2" style="display: none;">
                <img id="signature-image" src="" alt="Signature" class="mx-auto max-h-16 border border-gray-300 rounded">
                <p class="text-green-600 font-semibold mt-1">✓ SIGNED</p>
            </div>
            <div id="signature-placeholder" class="border-b border-gray-400 pb-2 mb-2">
                <p class="text-gray-400">______________________________________</p>
            </div>
            <p>Signature Over Printed Name</p>
        </div>
        
        <p class="mt-4 text-gray-600 italic">Thank you for your trust and confidence in our business.</p>
    </div>
</div>

<!-- Action Buttons - No Print -->
<div class="mt-8 flex flex-wrap justify-center items-center gap-3 sm:gap-4 no-print">
    {% if not edit_mode %}
        <button onclick="printContent()" class="inline-flex items-center justify-center px-4 py-2 sm:px-5 sm:py-2.5 bg-green-600 text-white font-semibold rounded-lg shadow-md hover:bg-green-700 focus:outline-none focus:ring-2 focus:ring-green-500 focus:ring-opacity-75 transition-all duration-200 text-sm sm:text-base">
            <span class="hidden sm:inline">Print Commission Slip</span>
            <span class="sm:hidden">Print</span>
        </button>

        
        <!-- Signature Upload Button -->
        <div class="mt-2">
            <input type="file" id="signature-upload" accept="image/*" style="display: none;" onchange="handleSignatureUpload(event)">
            <button type="button" onclick="document.getElementById('signature-upload').click()" class="inline-flex items-center justify-center px-4 py-2 sm:px-5 sm:py-2.5 bg-blue-600 text-white font-semibold rounded-lg shadow-md hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-opacity-75 transition-all duration-200 text-sm sm:text-base cursor-pointer">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15.232 5.232l3.536 3.536m-2.036-5.036a2.5 2.5 0 113.536 3.536L6.5 21.036H3v-3.572L16.732 3.732z"/>
                </svg>
                <span class="hidden sm:inline">Attach Signature</span>
                <span class="sm:hidden">Sign</span>
            </button>
            <button type="button" id="clear-signature" onclick="clearSignature()" class="inline-flex items-center justify-center px-4 py-2 sm:px-5 sm:py-2.5 bg-red-600 text-white font-semibold rounded-lg shadow-md hover:bg-red-700 focus:outline-none focus:ring-2 focus:ring-red-500 focus:ring-opacity-75 transition-all duration-200 text-sm sm:text-base" style="display: none;">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"/>
                </svg>
                <span class="hidden sm:inline">Clear</span>
                <span class="sm:hidden">Clear</span>
            </button>
        </div>
        
    {% else %}
        <button type="submit" class="action-button print-button">Save Changes</button>
    {% endif %}
</div>

<script>
    function printContent() {
        window.print();
    }
    
    function handleSignatureUpload(event) {
        const file = event.target.files[0];
        if (file) {
            // Validate file type
            if (!file.type.startsWith('image/')) {
                alert('Please select a valid image file.');
                return;
            }
            
            // Validate file size (max 5MB)
            if (file.size > 5 * 1024 * 1024) {
                alert('File size must be less than 5MB.');
                return;
            }
            
            const reader = new FileReader();
            reader.onload = function(e) {
                // Display the signature
                const signatureImage = document.getElementById('signature-image');
                const signatureDisplay = document.getElementById('signature-display');
                const signaturePlaceholder = document.getElementById('signature-placeholder');
                const clearButton = document.getElementById('clear-signature');
                
                signatureImage.src = e.target.result;
                signatureDisplay.style.display = 'block';
                signaturePlaceholder.style.display = 'none';
                clearButton.style.display = 'inline-flex';
                
                // Store signature in localStorage for persistence
                localStorage.setItem('voucher-signature-' + window.location.pathname, e.target.result);
            };
            reader.readAsDataURL(file);
        }
    }
    
    function clearSignature() {
        const signatureDisplay = document.getElementById('signature-display');
        const signaturePlaceholder = document.getElementById('signature-placeholder');
        const clearButton = document.getElementById('clear-signature');
        const signatureUpload = document.getElementById('signature-upload');
        
        // Hide signature and show placeholder
        signatureDisplay.style.display = 'none';
        signaturePlaceholder.style.display = 'block';
        clearButton.style.display = 'none';
        
        // Clear file input
        signatureUpload.value = '';
        
        // Remove from localStorage
        localStorage.removeItem('voucher-signature-' + window.location.pathname);
    }
    
    // Load saved signature on page load
    document.addEventListener('DOMContentLoaded', function() {
        const savedSignature = localStorage.getItem('voucher-signature-' + window.location.pathname);
        if (savedSignature) {
            const signatureImage = document.getElementById('signature-image');
            const signatureDisplay = document.getElementById('signature-display');
            const signaturePlaceholder = document.getElementById('signature-placeholder');
            const clearButton = document.getElementById('clear-signature');
            
            signatureImage.src = savedSignature;
            signatureDisplay.style.display = 'block';
            signaturePlaceholder.style.display = 'none';
            clearButton.style.display = 'inline-flex';
        }
    });
</script>

{% endblock %}
